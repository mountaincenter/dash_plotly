<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>分析 — ATR分離版</title>
<style>
:root {
  --bg: #09090b;
  --card: #18181b;
  --border: rgba(63,63,70,0.4);
  --border-light: rgba(63,63,70,0.2);
  --fg: #fafafa;
  --muted: #a1a1aa;
  --emerald: #34d399;
  --rose: #fb7185;
  --sky: #38bdf8;
  --amber: #fbbf24;
  --primary-bg: #3b82f6;
  --primary-fg: #fff;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Kaku Gothic ProN', sans-serif;
  background: var(--bg); color: var(--fg);
  line-height: 1.5; min-height: 100vh;
}
.container { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }

/* Cards */
.card {
  position: relative; overflow: hidden;
  border-radius: 12px; border: 1px solid var(--border);
  background: linear-gradient(135deg, rgba(24,24,27,0.5), rgba(24,24,27,0.8), rgba(24,24,27,0.5));
  padding: 20px;
  box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
  backdrop-filter: blur(20px);
}
.card::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.02), transparent, transparent);
  pointer-events: none;
}
.card .inner { position: relative; }

/* Top cards grid */
.top-cards { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px; }
.top-card { padding: 16px; }
.top-card .label { color: var(--muted); font-size: 14px; margin-bottom: 8px; }
.top-card .value { font-size: 24px; font-weight: 700; text-align: right; font-variant-numeric: tabular-nums; white-space: nowrap; }
.top-card .sub { font-size: 12px; text-align: right; margin-top: 4px; }

/* Section headers */
h1 { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
h2 { font-size: 14px; font-weight: 600; margin: 24px 0 12px; }
.subtitle { color: var(--muted); font-size: 13px; margin-bottom: 20px; }

/* Band table grid */
.band-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
.band-title { font-weight: 600; margin-bottom: 12px; font-size: 14px; }
.band-title.sky { color: var(--sky); }
.band-title.amber { color: var(--amber); }

/* Tables */
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th {
  padding: 8px 8px; border-bottom: 1px solid rgba(63,63,70,0.5);
  color: var(--muted); font-weight: 500; font-size: 12px; white-space: nowrap;
}
th.r { text-align: right; }
th.l { text-align: left; }
td { padding: 6px 8px; border-bottom: 1px solid var(--border-light); font-variant-numeric: tabular-nums; }
td.r { text-align: right; }
td.l { text-align: left; }
tr:hover { background: rgba(255,255,255,0.02); }

/* Colors */
.pos { color: var(--emerald); }
.neg { color: var(--rose); }
.muted { color: var(--muted); }
.white { color: var(--fg); }
.sky { color: var(--sky); }
.amber { color: var(--amber); }
.bold { font-weight: 700; }

/* Tabs */
.tabs { display: flex; gap: 4px; margin-bottom: 12px; }
.tab {
  padding: 4px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;
  background: rgba(39,39,42,0.3); color: var(--muted);
  border: 1px solid var(--border); transition: all 0.15s;
}
.tab:hover { background: rgba(39,39,42,0.5); }
.tab.active { background: var(--primary-bg); color: var(--primary-fg); border-color: var(--primary-bg); }

/* Weekday sections */
.weekday-section { margin-bottom: 20px; }
.weekday-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
.weekday-header h2 { margin: 0; font-size: 14px; font-weight: 600; }

/* Margin card */
.margin-card { margin-bottom: 16px; }
.margin-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
.margin-header .title { font-weight: 600; font-size: 18px; }
.margin-header .count { color: var(--muted); font-size: 16px; }
.margin-totals {
  display: flex; justify-content: flex-end; gap: 20px;
  margin-bottom: 12px; padding-bottom: 12px;
  border-bottom: 1px solid rgba(63,63,70,0.3);
}
.margin-totals .item { text-align: right; }
.margin-totals .item .label { color: var(--muted); font-size: 14px; }
.margin-totals .item .value { font-size: 20px; font-weight: 700; font-variant-numeric: tabular-nums; }

/* S2 vs S7 */
.s2s7-grid { display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 24px; }
.highlight-row { background: rgba(26,35,50,0.5) !important; }
.winner-cell { background: rgba(26,58,42,0.5); font-weight: 700; }
.separator-row td { border-top: 2px solid #f0883e; }
.tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
.tag-green { background: #238636; color: #fff; }
.tag-yellow { background: #9e6a03; color: #fff; }

/* Hybrid */
.hybrid-grid { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 24px; }
.hybrid-item {
  border-radius: 8px; border: 1px solid var(--border); padding: 12px 16px;
  background: var(--card); min-width: 140px;
}
.hybrid-item.primary { border-color: var(--primary-bg); }
.hybrid-item .value { font-size: 20px; font-weight: 700; font-variant-numeric: tabular-nums; }
.hybrid-item .label { font-size: 11px; color: var(--muted); margin-top: 2px; }

/* Conclusion box */
.conclusion-box {
  background: rgba(26,35,50,0.8); border: 1px solid #1f6feb;
  border-radius: 12px; padding: 16px; margin-bottom: 24px;
}
.conclusion-box h3 { margin: 0 0 8px; color: #58a6ff; font-size: 14px; }
.conclusion-box p { font-size: 13px; color: var(--muted); }

.footer { font-size: 11px; color: var(--muted); text-align: center; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border); }

/* ATR group tabs in weekday */
.atr-group-tabs { display: flex; gap: 4px; margin-left: auto; }

@media (max-width: 768px) {
  .top-cards { grid-template-columns: repeat(2, 1fr); }
  .band-grid { grid-template-columns: 1fr; }
  .top-card .value { font-size: 18px; }
}
</style>
</head>
<body>
<div class="container">
<h1>Grok分析 — ATR分離版</h1>
<p class="subtitle" id="subtitle"></p>

<!-- 結論ボックス -->
<div class="conclusion-box">
<h3>ATR >= 10% のトレードは大引けまで持ち切る</h3>
<p>ATR帯別S2 vs S7比較の結果、ATR 10%以上（139件）ではS7（大引け）がS2（RSI&lt;30利確）を上回る。RSI帯別分析を除外し、ATR 10%で分離表示。</p>
</div>

<!-- Top Cards -->
<div id="top-cards"></div>

<!-- ハイブリッド戦略 -->
<h2>ハイブリッド戦略: S2 + S7（ATR 10%切替）</h2>
<div id="hybrid-section"></div>

<!-- S2 vs S7 ATR帯別 -->
<h2>ATR帯別: S2 vs S7 直接比較</h2>
<p class="muted" style="margin-bottom:8px; font-size:13px;">S2=RSI(9)&lt;30利確（未発火時S7フォールバック）、S7=大引け持切り</p>
<div id="s2s7-section"></div>

<!-- ATR帯別（時間帯P&L） -->
<h2>ATR帯別 時間帯P&L</h2>
<div id="atr-section"></div>

<!-- 曜日別 -->
<h2>曜日別 × ATRグループ</h2>
<p class="muted" style="margin-bottom:8px; font-size:13px;">ATR&lt;10% / ATR≥10% を分離して表示。信用区分別 × 価格帯。</p>
<div id="weekday-section"></div>

<div class="footer" id="footer"></div>
</div>

<script>
fetch('analysis_data.json').then(r => r.json()).then(data => {
  const fmt = v => v == null ? '-' : (v >= 0 ? '+' : '') + Math.round(v).toLocaleString();
  const pct = v => v == null ? '-' : Math.round(v) + '%';

  // 4区分色分けロジック（page.tsx getQuadrantClasses 完全再現）
  function getQuadrantClasses(me, p1, ae, p2) {
    const values = [me, p1, ae, p2];
    const positives = values.filter(v => v > 0);
    const negatives = values.filter(v => v < 0);
    const WHITE = 'white';
    const GREEN = 'pos';
    const RED = 'neg';

    if (positives.length === 4) {
      const maxVal = Math.max(...values);
      return values.map(v => v === maxVal ? GREEN : WHITE);
    }
    if (negatives.length === 4) {
      const minVal = Math.min(...values);
      return values.map(v => v === minVal ? RED : WHITE);
    }
    if (positives.length === 0 && negatives.length === 0) {
      return [WHITE, WHITE, WHITE, WHITE];
    }
    const maxPositive = positives.length > 0 ? Math.max(...positives) : null;
    const minNegative = negatives.length > 0 ? Math.min(...negatives) : null;
    return values.map(v => {
      if (v > 0 && v === maxPositive) return GREEN;
      if (v < 0 && v === minNegative) return RED;
      return WHITE;
    });
  }

  function profitClass(v) { return v > 0 ? 'pos' : v < 0 ? 'neg' : 'white'; }
  function winrateClass(v) { return v > 50 ? 'pos' : v < 50 ? 'neg' : 'white'; }

  const sm = data.summary;
  const times = ['10:25', '前引', '14:45', '大引'];

  // Subtitle
  document.getElementById('subtitle').textContent =
    `${sm.date_min} ~ ${sm.date_max} (${sm.total}件) — RSI帯別除外、ATR 10%分離`;

  // === Top Cards ===
  // 3行: 全体 / ATR<10% / ATR>=10%
  const groups = [
    { key: 'all', label: '全体', count: sm.total },
    { key: 'atr_lo', label: 'ATR<10%', count: sm.atr_lo_count },
    { key: 'atr_hi', label: 'ATR≥10%', count: sm.atr_hi_count },
  ];

  let topHtml = '';
  for (const g of groups) {
    const pnls = times.map(t => sm[`${g.key}_${t}_pnl`] ?? 0);
    const wrs = times.map(t => sm[`${g.key}_${t}_wr`] ?? 0);
    const ns = times.map(t => sm[`${g.key}_${t}_n`] ?? 0);
    const [meC, p1C, aeC, p2C] = getQuadrantClasses(...pnls);
    const classes = [meC, p1C, aeC, p2C];

    topHtml += '<div class="top-cards">';
    // 総件数
    topHtml += `<div class="card top-card"><div class="inner">
      <div class="label">${g.label}</div>
      <div class="value white">${g.count}</div>
      <div class="sub muted">件数</div>
    </div></div>`;
    // 4区分
    for (let i = 0; i < 4; i++) {
      topHtml += `<div class="card top-card"><div class="inner">
        <div class="label">${times[i]}</div>
        <div class="value ${classes[i]}">${fmt(pnls[i])}円</div>
        <div class="sub ${winrateClass(wrs[i])}">勝率 ${Math.round(wrs[i])}% (${ns[i]}件)</div>
      </div></div>`;
    }
    topHtml += '</div>';
  }
  document.getElementById('top-cards').innerHTML = topHtml;

  // === Hybrid ===
  const hy = data.hybrid;
  const vs_s2 = hy.pnl - hy.s2_only;
  const vs_s7 = hy.pnl - hy.s7_only;
  let hh = '<div class="hybrid-grid">';
  hh += `<div class="hybrid-item primary"><div class="value ${profitClass(hy.pnl)}">${fmt(hy.pnl)}</div><div class="label">ハイブリッド (${hy.n}件, 勝率${pct(hy.wr)})</div></div>`;
  hh += `<div class="hybrid-item"><div class="value ${profitClass(hy.s2_only)}">${fmt(hy.s2_only)}</div><div class="label">S2単体 (フォールバック込)</div></div>`;
  hh += `<div class="hybrid-item"><div class="value ${profitClass(hy.s7_only)}">${fmt(hy.s7_only)}</div><div class="label">S7単体 (大引け)</div></div>`;
  hh += `<div class="hybrid-item"><div class="value ${profitClass(vs_s2)}">${fmt(vs_s2)}</div><div class="label">vs S2改善</div></div>`;
  hh += `<div class="hybrid-item"><div class="value ${profitClass(vs_s7)}">${fmt(vs_s7)}</div><div class="label">vs S7改善</div></div>`;
  hh += '</div>';
  document.getElementById('hybrid-section').innerHTML = hh;

  // === S2 vs S7 ===
  let st = '<div class="card" style="margin-bottom:24px"><div class="inner"><table>';
  st += '<tr><th class="l">ATR帯</th><th class="r">件数</th><th class="r">S2合計</th><th class="r">S2勝率</th><th class="r">S7合計</th><th class="r">S7勝率</th><th class="r">勝者</th><th class="r">差分</th></tr>';
  for (const row of data.s2s7_table) {
    const diff = row.s2_pnl - row.s7_pnl;
    const isHi = row.label === '10-15' || row.label === '>15';
    const rowCls = isHi ? 'highlight-row' : '';
    const s2Cls = row.winner === 'S2' ? 'winner-cell' : '';
    const s7Cls = row.winner === 'S7' ? 'winner-cell' : '';
    const sepCls = row.label === '10-15' ? ' separator-row' : '';
    st += `<tr class="${rowCls}${sepCls}">`;
    st += `<td class="l">${row.label}%</td>`;
    st += `<td class="r">${row.n}</td>`;
    st += `<td class="r ${profitClass(row.s2_pnl)} ${s2Cls}">${fmt(row.s2_pnl)}</td>`;
    st += `<td class="r">${pct(row.s2_wr)}</td>`;
    st += `<td class="r ${profitClass(row.s7_pnl)} ${s7Cls}">${fmt(row.s7_pnl)}</td>`;
    st += `<td class="r">${pct(row.s7_wr)}</td>`;
    st += `<td class="r"><span class="tag ${row.winner === 'S2' ? 'tag-green' : 'tag-yellow'}">${row.winner}</span></td>`;
    st += `<td class="r ${profitClass(diff)}">${fmt(diff)}</td>`;
    st += '</tr>';
  }
  st += '</table></div></div>';
  document.getElementById('s2s7-section').innerHTML = st;

  // === ATR帯別 ===
  const atrLo = data.atr_table.filter(r => {
    const lo = parseFloat(r.label.replace('>', ''));
    return lo < 10;
  });
  const atrHi = data.atr_table.filter(r => {
    const lo = parseFloat(r.label.replace('>', ''));
    return lo >= 10;
  });

  function renderAtrTable(rows, title, titleClass) {
    let t = `<div class="card"><div class="inner"><div class="band-title ${titleClass || ''}">${title}</div><table>`;
    t += '<tr><th class="l">ATR</th><th class="r">件</th>';
    for (const tp of times) t += `<th class="r">${tp}</th>`;
    t += '</tr>';
    for (const row of rows) {
      const pnls = times.map(tp => row[`${tp}_pnl`] ?? 0);
      const [c0, c1, c2, c3] = getQuadrantClasses(...pnls);
      const cs = [c0, c1, c2, c3];
      t += `<tr><td class="l muted">${row.label}%</td><td class="r">${row.n}</td>`;
      for (let i = 0; i < 4; i++) {
        t += `<td class="r ${cs[i]}">${fmt(pnls[i])}</td>`;
      }
      t += '</tr>';
    }
    t += '</table></div></div>';
    return t;
  }
  document.getElementById('atr-section').innerHTML =
    '<div class="band-grid">' +
    renderAtrTable(atrLo, `ATR < 10% — S2適用 (${sm.atr_lo_count}件)`) +
    renderAtrTable(atrHi, `ATR ≥ 10% — S7適用 (${sm.atr_hi_count}件)`) +
    '</div>';

  // === 曜日別 ===
  const weekdays = ['月', '火', '水', '木', '金'];
  let wdHtml = '';

  for (const wd of weekdays) {
    const wdData = data.weekdays[wd];
    if (!wdData) continue;

    wdHtml += `<div class="weekday-section">`;
    wdHtml += `<div class="weekday-header"><h2>${wd}曜日</h2></div>`;

    // ATR<10% / ATR>=10% を横並び
    wdHtml += '<div class="band-grid">';

    for (const atrGrp of ['ATR<10%', 'ATR≥10%']) {
      wdHtml += '<div>';

      for (const mt of ['制度信用', 'いちにち信用']) {
        const key = `${atrGrp}_${mt}`;
        const mtData = wdData[key];
        if (!mtData || mtData.total === 0) continue;

        const mtColor = mt === '制度信用' ? 'sky' : 'amber';

        wdHtml += `<div class="card margin-card"><div class="inner">`;
        wdHtml += `<div class="margin-header">
          <span class="title white">${atrGrp} ${mt}</span>
          <span class="count">${mtData.total}件</span>
        </div>`;

        // Totals row
        const totPnls = times.map(t => mtData[`${t}_pnl`] ?? 0);
        const totWrs = times.map(t => mtData[`${t}_wr`] ?? 0);
        const [tc0, tc1, tc2, tc3] = getQuadrantClasses(...totPnls);
        const totCs = [tc0, tc1, tc2, tc3];

        wdHtml += '<div class="margin-totals">';
        for (let i = 0; i < 4; i++) {
          wdHtml += `<div class="item">
            <div class="label">${times[i]}</div>
            <div class="value ${totCs[i]}">${fmt(totPnls[i])}</div>
          </div>`;
        }
        wdHtml += '</div>';

        // Price band table
        wdHtml += '<table><tr><th class="r">価格帯</th><th class="r">件</th>';
        for (const tp of times) wdHtml += `<th class="r">${tp}</th><th class="r">%</th>`;
        wdHtml += '</tr>';

        for (const pb of mtData.price_bands) {
          if (pb.n === 0) continue;
          const pbPnls = times.map(t => pb[`${t}_pnl`] ?? 0);
          const [pc0, pc1, pc2, pc3] = getQuadrantClasses(...pbPnls);
          const pcs = [pc0, pc1, pc2, pc3];

          wdHtml += `<tr><td class="r muted">${pb.label}</td><td class="r">${pb.n}</td>`;
          for (let i = 0; i < 4; i++) {
            const w = pb[`${times[i]}_wr`] ?? 0;
            wdHtml += `<td class="r ${pcs[i]}">${fmt(pbPnls[i])}</td>`;
            wdHtml += `<td class="r ${winrateClass(w)}">${Math.round(w)}%</td>`;
          }
          wdHtml += '</tr>';
        }
        wdHtml += '</table>';
        wdHtml += '</div></div>'; // inner, card
      }
      wdHtml += '</div>'; // column
    }
    wdHtml += '</div>'; // band-grid
    wdHtml += '</div>'; // weekday-section
  }
  document.getElementById('weekday-section').innerHTML = wdHtml;

  // Footer
  document.getElementById('footer').textContent =
    `Generated at ${new Date().toLocaleString('ja-JP')} | データ: ${sm.total}件 | ATR≥10%: ${sm.atr_hi_count}件 | ATR<10%: ${sm.atr_lo_count}件`;
});
</script>
</body>
</html>
