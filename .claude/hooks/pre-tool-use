#!/bin/bash
# pre-tool-use hook
# CLAUDE.mdで禁止されている操作を技術的に制御

TOOL_NAME="$1"
COMMAND="$2"

# ============================================================
# セクション4: Git操作の制限
# ============================================================

# git push の禁止（明示的許可なし）
if [[ "$TOOL_NAME" == "Bash" ]] && [[ "$COMMAND" =~ "git push" ]]; then
    echo "⚠️  git pushはユーザーの明示的許可が必要です"
    echo "詳細: .claude/CLAUDE.md セクション4"
    echo ""
    echo "手順:"
    echo "  1. commitまで実行"
    echo "  2. 「commit完了。pushしてよろしいですか?」と確認"
    echo "  3. 明示的指示を待つ"
    exit 1
fi

# git push --force の禁止
if [[ "$TOOL_NAME" == "Bash" ]] && [[ "$COMMAND" =~ "git push.*--force" ]]; then
    echo "⚠️  git push --force は破壊的操作のため禁止されています"
    echo "詳細: .claude/CLAUDE.md セクション4"
    exit 1
fi

# git commit --amend の制限
if [[ "$TOOL_NAME" == "Bash" ]] && [[ "$COMMAND" =~ "git commit.*--amend" ]]; then
    echo "⚠️  git commit --amend は制限されています"
    echo "詳細: .claude/CLAUDE.md セクション4"
    echo ""
    echo "許可される場合:"
    echo "  1. ユーザーが明示的に指示"
    echo "  2. pre-commitフックによる修正の追加"
    echo ""
    echo "実行前に authorship を確認してください:"
    echo "  git log -1 --format='%an %ae'"
    exit 1
fi

# ============================================================
# セクション11: 不要なファイル作成の絶対禁止
# ============================================================

if [[ "$TOOL_NAME" == "Write" ]]; then
    FILE_PATH="$COMMAND"

    # ドキュメント系ファイル
    if [[ "$FILE_PATH" =~ README\.md$ ]] || \
       [[ "$FILE_PATH" =~ CHANGELOG\.md$ ]] || \
       [[ "$FILE_PATH" =~ CONTRIBUTING\.md$ ]] || \
       [[ "$FILE_PATH" =~ docs/.+ ]]; then
        echo "⚠️  ドキュメントファイルの作成は明示的依頼がない限り禁止"
        echo "ファイル: $FILE_PATH"
        echo "詳細: .claude/CLAUDE.md セクション11"
        exit 1
    fi

    # テスト系ファイル
    if [[ "$FILE_PATH" =~ test_.+\.py$ ]] || \
       [[ "$FILE_PATH" =~ .+\.test\.(ts|js|tsx|jsx)$ ]] || \
       [[ "$FILE_PATH" =~ .+\.spec\.(ts|js|tsx|jsx)$ ]] || \
       [[ "$FILE_PATH" =~ fixtures/ ]] || \
       [[ "$FILE_PATH" =~ mocks/ ]]; then
        echo "⚠️  テストファイルの作成は明示的依頼がない限り禁止"
        echo "ファイル: $FILE_PATH"
        echo "詳細: .claude/CLAUDE.md セクション11"
        exit 1
    fi

    # サンプル・ダミー系ファイル
    if [[ "$FILE_PATH" =~ example\. ]] || \
       [[ "$FILE_PATH" =~ sample\. ]] || \
       [[ "$FILE_PATH" =~ dummy ]]; then
        echo "⚠️  サンプル/ダミーファイルの作成は明示的依頼がない限り禁止"
        echo "ファイル: $FILE_PATH"
        echo "詳細: .claude/CLAUDE.md セクション11"
        exit 1
    fi
fi

# ============================================================
# セクション15: 金銭的コストが発生する操作の絶対禁止
# ============================================================

if [[ "$TOOL_NAME" == "Bash" ]]; then
    # Grok API呼び出し（generate_market_summary.py）
    if [[ "$COMMAND" =~ generate_market_summary ]]; then
        echo "⚠️  このコマンドはGrok APIを呼び出します（課金発生）"
        echo "ユーザーの明示的指示がない限り実行できません"
        echo "詳細: .claude/CLAUDE.md セクション15"
        exit 1
    fi

    # GitHub Actions workflow_dispatch
    if [[ "$COMMAND" =~ "gh workflow run" ]]; then
        echo "⚠️  このコマンドはGitHub Actionsを手動実行します（課金発生）"
        echo "ユーザーの明示的指示がない限り実行できません"
        echo "詳細: .claude/CLAUDE.md セクション15"
        exit 1
    fi

    # OpenAI API呼び出し
    if [[ "$COMMAND" =~ "openai" ]]; then
        echo "⚠️  このコマンドはOpenAI APIを呼び出します（課金発生）"
        echo "ユーザーの明示的指示がない限り実行できません"
        echo "詳細: .claude/CLAUDE.md セクション15"
        exit 1
    fi

    # AWS EC2インスタンス起動
    if [[ "$COMMAND" =~ "aws ec2 run-instances" ]]; then
        echo "⚠️  EC2インスタンスの起動は課金が発生します"
        echo "ユーザーの明示的指示がない限り実行できません"
        echo "詳細: .claude/CLAUDE.md セクション15"
        exit 1
    fi

    # AWS Lambda関数作成
    if [[ "$COMMAND" =~ "aws lambda create-function" ]]; then
        echo "⚠️  Lambda関数の作成は課金が発生する可能性があります"
        echo "ユーザーの明示的指示がない限り実行できません"
        echo "詳細: .claude/CLAUDE.md セクション15"
        exit 1
    fi

    # AWS RDS作成
    if [[ "$COMMAND" =~ "aws rds create-db-instance" ]]; then
        echo "⚠️  RDSインスタンスの作成は課金が発生します"
        echo "ユーザーの明示的指示がない限り実行できません"
        echo "詳細: .claude/CLAUDE.md セクション15"
        exit 1
    fi

    # Terraform apply（リソース作成の可能性）
    if [[ "$COMMAND" =~ "terraform apply" ]] && [[ ! "$COMMAND" =~ "-destroy" ]]; then
        echo "⚠️  terraform apply は課金が発生する可能性があります"
        echo "ユーザーの明示的指示がない限り実行できません"
        echo "詳細: .claude/CLAUDE.md セクション15"
        exit 1
    fi
fi

# 正常終了
exit 0
