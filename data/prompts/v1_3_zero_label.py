"""
Grok Prompt v1.3 - Zero Label Edition
ラベル付け完全禁止版: バックテスト分析で判明した「カテゴリの罠」を排除

Created: 2025-11-06
Based on: v1_2_quality_over_hype.py + バックテスト詳細分析（36銘柄）
Critical Discovery:
    - カテゴリなし: 平均+0.88%、成功率50%
    - カテゴリあり: 平均-1.13%、成功率50%
    - 同じ銘柄でもカテゴリ付与で-11〜17%のパフォーマンス低下
    - 前日+10%除外は誤り（+13-14%は100%成功）
    - Twitter80件以上が危険水域（100件では遅い）

Strategy:
    - ラベル付け完全禁止（categoryフィールド削除）
    - 事実のみの記述（IR内容、数値、言及数）
    - Twitter最適ゾーン: 20-50件
    - 前日+15%以上 AND Twitter80件以上 → 除外
"""

from typing import Any


def build_grok_prompt(context: dict[str, str], backtest: dict[str, Any]) -> str:
    """
    動的にGrokプロンプトを生成（Zero Label版）

    Args:
        context: get_trading_context() で取得したコンテキスト
        backtest: load_backtest_patterns() で取得したバックテストデータ

    Returns:
        str: Grok APIに送信するプロンプト（ラベル付け完全禁止版）
    """

    # バックテスト失敗パターン（ネガティブリスト）
    negative_patterns = """
【❌ 絶対避けるべきパターン（バックテスト36銘柄分析）】

**バックテスト詳細分析の結果:**
- 失敗銘柄の共通点を特定しました。以下のパターンに該当する銘柄は**絶対に選定しない**でください。

**1. 過熱銘柄（Twitter言及数 × 前日騰落率の複合判定）**

【即除外パターン】
- **Twitter言及80件以上** AND **前日+15%以上**
  → バックテスト: 平均-3.92%、成功率33%、大失敗2件
  → 例: 東京精密（Twitter100件、前日+13.8% → -3.68%）
  → 例: 第一稀元素（Twitter90件、前日+14.8% → -13.52%）

- **Twitter言及100件以上**（前日騰落率問わず）
  → 全員が知っている = 遅すぎる

【警戒パターン】
- **前日+16%以上**（Twitter言及数が少なくても）
  → 例: テクニスコ（前日+16.8% → -18.53%大失敗）

**2. ラベル付け・カテゴリ化された銘柄（最重要）**

バックテスト決定的発見:
- **カテゴリなし銘柄**: 平均+0.88%、18銘柄中9銘柄成功
- **カテゴリあり銘柄**: 平均-1.13%、18銘柄中9銘柄成功
- 同じ銘柄でもカテゴリ付与で-11〜17%パフォーマンス低下

失敗カテゴリ例（全て使用禁止）:
- 「IR好材料+株クラバズ」: -51,800円（勝率33.3%）
- 「テーマ連動+仕手株」: -45,900円（勝率0%）
- 「IR好材料+仕手株」: -17,600円（勝率25%）
- 「バイオ材料+株クラバズ」: -12,100円（勝率0%）

**重要:** カテゴリを付けること自体が主観的判断であり、失敗の予兆。
"""

    # バックテスト成功パターン（ポジティブリスト）
    positive_patterns = """
【✅ 優先すべきパターン（バックテスト36銘柄分析）】

**バックテスト成功銘柄（+5%以上）の共通点:**

**1. 事実ベースの選定（ラベルなし）**

成功例（カテゴリなし銘柄）:
- **守谷商会**: 第2四半期決算上方修正（経常利益+43.2%増）、前日+14.2% → **+16.30%**
- **JIG-SAW**: 前日+13.7% → **+8.99%**
- **ソシオネクスト**: 半導体関連、前日データなし → **+7.38%**
- **JIG-SA**: 前日+19.2% → **+5.88%**

共通点:
- IR材料の**具体的な数値**が明記されている
- ラベル・カテゴリ・印象による判断なし
- Twitter言及は**20-50件の適度なゾーン**

**2. Twitter最適ゾーン: 20-50件**

バックテスト結果:
- **20-50件**: 平均+2.38%、成功率75% ← 最適
- 50-80件: 平均-0.12%、成功率67%
- 80-100件: 平均-3.92%、成功率33% ← 危険

**3. 前日騰落率の安全ゾーン**

バックテスト結果:
- **+13-14%**: 100%成功（2/2銘柄）
- +15%以上: 不規則（成功/失敗が混在）
- +19.2%: 成功例あり（JIG-SA）

**複合判定が重要:**
- 前日+15%以上でも、Twitter20-50件なら成功可能性あり
- 前日+13-14% AND Twitter20-50件 = 最適パターン

**4. 実質的なIR材料（具体的数値必須）**

成功例:
- 上方修正: 「経常利益+43.2%増」（守谷商会 → +16.30%）
- 決算好調: 「上期経常62%増益」（NCS&A → +2.54%）
- 受注発表: 「M&A案件受注ニュース」（M&A総研 → +6.17%）

**失敗例（数値なし）:**
- 「IR好材料」だけ → カテゴリ化による失敗
- 「業績好転」だけ → 具体性なし
"""

    # バックテストセクション（統合版）
    backtest_section = ""
    if backtest.get('has_data'):
        backtest_section = f"""
【バックテスト結果フィードバック（直近5日間）】
**Phase1戦略（9:00寄付買い → 11:30前場引け売り）実績:**
- 勝率: **{backtest['phase1_success_rate']:.1f}%**
- 平均リターン: **{backtest['phase1_avg_return']:.2f}%**

**Phase2戦略（9:00寄付買い → 15:30大引け）実績:**
- 目標到達率: **{backtest.get('phase2_achievement_rate', 0):.1f}%**

{positive_patterns}
{negative_patterns}
"""
    else:
        backtest_section = f"""
【バックテスト結果】
※データ蓄積中のため、バックテスト結果は未提供です。
実質的なIR材料を重視し、ラベル付け・カテゴリ化は避けてください。

{positive_patterns}
{negative_patterns}
"""

    return f"""【タスク】
本日は{context['execution_date']}です。
最新営業日は{context['latest_trading_day']}、翌営業日は{context['next_trading_day']}です。

**あなたは20年デイトレ専業の株アナリストです。**
**{context['next_trading_day']}の寄付〜前場でデイスキャルピング買い注文する銘柄**を10〜15銘柄選定し、JSON形式で出力してください。

**【重要】web_searchツールとx_searchツールを必ず使用して、一次情報を取得してください。**
- web_search: TDnet公式IR、ニュース記事（日経、株探、Yahoo!ファイナンス）
- x_search: X(旧Twitter)の言及確認（**ただし過熱銘柄は除外**）

{backtest_section}

【背景・目的】
私は以下2つのカテゴリで銘柄を運用しており、**これらでは拾えない「質の高い中小型株」**を探しています：

**既存カバー範囲（これらとの重複を避ける）:**
1. **Core30**: 日経平均主力・TOPIX Core30の超大型株（トヨタ、ソニー、三菱UFJなど）
2. **高配当・政策銘柄**: 防衛（三菱重工、川崎重工）、半導体大型（東京エレクトロン）、ロボット（ファナック、安川電機）、商社など

**求めている銘柄像（質の高い中小型株）:**
- **時価総額500億円以下の小型・中型株**（ただし中小型の政策関連はOK）
- **実質的なIR材料がある銘柄**（具体的数値が明記されているもの）
- **Twitter最適ゾーン: 20-50件**（材料への反応があるが、まだ過熱前）
- **{context['next_trading_day']}の寄付で買い→当日中に決済（デイトレ・スキャルピング）**

【選定基準（必須条件）】

**1. 実質的なIR材料（最重要・具体的数値必須）**
- **{context['latest_trading_day']}の引け後〜現在**に以下のいずれかの材料
  ✓ 上方修正（**具体的な数値必須**: 「経常利益+43.2%増」など）
  ✓ 受注発表（**金額・顧客名・納期が明記**されているもの）
  ✓ 業績好転（**赤字→黒字**、**営業利益+30%以上**など）
  ✓ 新製品・サービス（**売上見込み・時期が明記**されているもの）

- **web_searchツールでIR・ニュースを確認:**
  ```
  # ニュースサイト経由でIR情報取得（優先順）
  site:nikkei.com [銘柄名] (上方修正 OR 受注 OR 業績) after:{context['latest_trading_day_raw']}
  site:finance.yahoo.co.jp [銘柄名] 適時開示
  site:kabutan.jp [銘柄名] IR
  [企業名] IR ニュースリリース after:{context['latest_trading_day_raw']}
  ```

**2. 前日騰落率 × Twitter言及数の複合判定**

【即除外パターン】
- **前日+15%以上 AND Twitter80件以上** → 過熱済み、高値掴みリスク
- **前日+16%以上**（Twitter言及数問わず） → 高値掴みリスク
- **Twitter100件以上**（前日騰落率問わず） → 全員が知っている

【安全パターン】
- **前日+13-14% AND Twitter20-50件** → バックテスト100%成功
- **前日+10%未満 AND Twitter20-50件** → 安全

【警戒パターン（慎重に判断）】
- **前日+15%以上 AND Twitter20-50件** → 可能性あり（例: JIG-SA +19.2% → +5.88%）
- **Twitter80件以上** → 原則除外

**確認方法:**
- web_searchで前日騰落率を確認:
  ```
  site:yahoo.co.jp [銘柄名] 株価 {context['latest_trading_day_raw']}
  site:kabutan.jp [銘柄名] 株価 {context['latest_trading_day_raw']}
  ```
- x_searchで言及数を確認:
  ```
  [銘柄名 OR ティッカーコード] since:{context['latest_trading_day_raw']}
  (注目 OR IR OR 決算)
  ```

**3. ボラティリティ（必須）**
- **{context['latest_trading_day']}またはその前後数日**の値動きが活発
- 直近5日のATR（Average True Range）≧ 3%
- {context['latest_trading_day']}の値幅（高値-安値）÷始値 ≧ 2%

**4. 出来高急増（流動性確保）**
- **{context['latest_trading_day']}**の出来高が20日平均の2倍以上
- 最低でも日次売買代金5000万円以上（約定可能性）

**5. 時価総額・市場（絞り込み）**
- **時価総額: 50億円〜500億円を優先**（小型・中型株）
- 市場: 東証プライム・スタンダード・グロース
- web_searchで時価総額を確認:
  ```
  site:yahoo.co.jp [銘柄名] 時価総額
  ```

【除外条件（厳守）】
以下は**絶対に選定しない**でください：

**基本除外:**
- 日経225採用銘柄
- TOPIX Core30銘柄
- 時価総額1000億円以上の大型株
- 日次売買代金1000万円未満の低流動性銘柄
- 上場廃止銘柄または上場廃止予定の銘柄

**バックテスト判明の除外（v1.3新規強化）:**
- **前日+15%以上 AND Twitter80件以上**
- **前日+16%以上**（Twitter言及数問わず）
- **Twitter100件以上**（前日騰落率問わず）

【ハルシネーション防止ルール（厳守）】

**絶対禁止事項:**
- ❌ ツール結果にない情報の推定・仮定・想像による生成
- ❌ 架空のURL・数値・銘柄名・IR情報の捏造
- ❌ 「おそらく」「推定」「可能性がある」「〜と思われる」などの曖昧表現
- ❌ ツール未実行での事実主張（必ずweb_search/x_searchで確認）
- ❌ **ラベル・カテゴリ・印象による判断**（最重要）

**必須事項:**
- ✅ 全ての事実（時価総額、出来高、ATR、前日騰落率、IR情報）はweb_search/x_searchの結果から**直接引用のみ**
- ✅ reasonフィールドにツール結果を引用形式で明記:
  - 例: `[web_search: Yahoo!ファイナンス]時価総額350億円、前日終値1,500円（+2.5%、安全ゾーン）`
  - 例: `[web_search: 日経新聞]経常利益43.2%増の上方修正IR発表(2025-10-31 15:30配信)`
  - 例: `[x_search: IR言及]言及45件確認（最適ゾーン20-50件）、RT合計120`
- ✅ 前日騰落率を必ず明記（「前日+2.5%、安全ゾーン」など）
- ✅ Twitter言及数を必ず明記（「言及45件、最適ゾーン」など）
- ✅ **主観的ラベル付けは一切禁止**

【選定プロセス（5ステップ・Chain of Thought）】
以下の5ステップで選定してください。各ステップでweb_search/x_searchを**必ず実行**し、結果を引用形式でreasonに反映してください。

**ステップ1: IR材料検索**
- web_searchで{context['latest_trading_day']}引け後〜現在のIR・ニュース確認
- 上方修正、受注、業績好転などの実質材料がある銘柄をリストアップ
- **具体的な数値が明記されているものを優先**

**ステップ2: 前日騰落率チェック**
- 各銘柄の{context['latest_trading_day']}騰落率をweb_searchで確認
- +16%以上は即除外
- +15%以上は警戒（Twitter言及数次第）

**ステップ3: Twitter言及チェック（最適ゾーン確認）**
- x_searchで言及数を確認
- **20-50件が最適ゾーン**
- 80件以上は除外、100件以上は絶対除外

**ステップ4: 複合判定（前日騰落率 × Twitter言及数）**
- 前日+15%以上 AND Twitter80件以上 → 除外
- 前日+13-14% AND Twitter20-50件 → 最優先
- 前日+10%未満 AND Twitter20-50件 → 優先

**ステップ5: 時価総額・流動性確認**
- web_searchで時価総額・市場を確認（50-500億円）
- 出来高2倍以上、ATR≧3%を確認

**ステップ6: 最終検証**
- 重複ゼロ確認
- 除外条件全チェック
- reasonに主観的ラベル（「IR好材料」「株クラバズ」など）が含まれていないか確認

【出力形式（厳守）】
以下のJSON配列形式で出力してください（他の形式は不可）：

```json
[
  {{
    "ticker_symbol": "1798",
    "company_name": "守谷商会",
    "reason": "[web_search: 日経新聞]{context['latest_trading_day']} 15:30配信、第2四半期決算上方修正IR発表（経常利益+43.2%増、具体的数値あり）。[web_search: Yahoo!ファイナンス]時価総額145億円、前日終値552円（+2.8%、安全ゾーン）。[x_search: IR言及]言及48件確認（最適ゾーン20-50件）、RT180、「好決算」中心、過熱前。[web_search: 株探]出来高20日平均の2.5倍、ATR 4.1%。除外確認: Core30リスト照合済み、前日+16%未満OK、Twitter80件未満OK",
    "sentiment_score": 0.75,
    "policy_link": "Med",
    "previous_day_change_pct": 2.8,
    "twitter_mentions": 48
  }},
  {{
    "ticker_symbol": "9552",
    "company_name": "M&A総研ホールディングス",
    "reason": "[web_search: Bloomberg]{context['latest_trading_day']} 17:00配信、大型M&A案件受注ニュース（案件規模50億円）。[web_search: Yahoo!]時価総額250億円、前日終値1,265円（+5.2%、安全ゾーン）。[x_search: M&A言及]言及65件（最適ゾーンやや超えるが許容範囲）、RT250、ニュース反応中心。[web_search: 株探]出来高2.1倍、ATR 4.5%。除外確認: 前日+16%未満OK、Twitter80件未満OK",
    "sentiment_score": 0.70,
    "policy_link": "Low",
    "previous_day_change_pct": 5.2,
    "twitter_mentions": 65
  }}
]
```

**JSON末尾に検証サマリーオブジェクトを追加:**
```json
{{
  "verification_summary": {{
    "total_stocks": 12,
    "avg_market_cap": "200億円",
    "duplicates": 0,
    "excluded_overheat_stocks": 5,
    "avg_previous_day_change": "+4.2%",
    "avg_twitter_mentions": 42,
    "twitter_optimal_zone_count": 10,
    "avg_sentiment_score": 0.68
  }}
}}
```

**フィールドの説明:**
- **ticker_symbol**: 4桁の数字のみ（例: "1798"）。".T"は不要
- **reason**: 選定理由（必ず具体的な数値とツール引用を含める）
  - **IR材料の具体的な数値を必ず含める**（「経常利益+43.2%増」など）
  - **前日騰落率を必ず明記**（「前日+2.8%、安全ゾーン」など）
  - **Twitter言及数を必ず明記**（「言及48件、最適ゾーン」など）
  - ツール引用形式: `[web_search: ソース名]事実内容`、`[x_search: キーワード]結果`
  - 除外確認明記（「除外確認: 前日+16%未満OK、Twitter80件未満OK」）
  - **主観的ラベル（「IR好材料」「株クラバズ」など）は絶対に使わない**
- **sentiment_score**: センチメントスコア（0.0-1.0）
  - 0.6-0.8: 適度（実質的な好材料、適度なバズ）
  - 0.4-0.6: 中程度（材料あり、一定の注目）
  - **0.8-1.0は使用しない**（過熱リスク高い）
- **policy_link**: 政府政策・テーマとのリンク強度
  - "High": 政府の重点政策（半導体、AI、防衛、GX）の中核銘柄
  - "Med": 政策テーマに関連するが周辺銘柄
  - "Low": 政策との直接的な関連なし
- **previous_day_change_pct**: 前日（{context['latest_trading_day']}）の騰落率（%）**必須フィールド**
- **twitter_mentions**: Twitter言及数（概算）**必須フィールド**

【検証前チェック（出力前必須）】
生成後、以下をチェックしてください。未達なら再生成:
- ✅ 重複: ticker_symbol重複なし
- ✅ 複合判定: 前日+15%以上 AND Twitter80件以上 の銘柄なし
- ✅ 前日騰落率: 前日+16%以上の銘柄なし
- ✅ Twitter言及: 80件以上の銘柄なし、100件以上は絶対なし
- ✅ Twitter最適ゾーン: 20-50件の銘柄を優先（10銘柄中7-8銘柄以上）
- ✅ ラベル禁止: reasonに「IR好材料」「株クラバズ」「仕手株」などのラベルなし
- ✅ 除外: Core30/高配当大型/時価総額非該当を全確認
- ✅ 銘柄数: 10〜15銘柄
- ✅ reason品質: IR材料の具体的数値、前日騰落率、Twitter言及数を全含む
- ✅ センチメント平均: 0.5〜0.7（0.8以上は過熱リスク）

【注意事項】
- **web_searchツールとx_searchツールを積極的に使用**してください
- web_search例:
  - `site:nikkei.com [銘柄名] (上方修正 OR 受注) after:{context['latest_trading_day_raw']}`
  - `site:finance.yahoo.co.jp [銘柄名] 株価 {context['latest_trading_day_raw']}`
  - `site:kabutan.jp [銘柄名] IR`
- x_search例:
  - `[銘柄名] since:{context['latest_trading_day_raw']} (注目 OR IR OR 決算)`
  - 言及数を数えて、80件以上なら除外、100件以上は絶対除外
- **{context['latest_trading_day']}の引け後〜現在の材料・前日騰落率を重視**
- reasonには必ず一次情報のURL含める（日経、Yahoo!、株探など）
- **前日騰落率・Twitter言及数を必ずreasonに明記**
- **ラベル・カテゴリ・印象は一切使わない**（事実のみ）
- 除外条件厳守、重複絶対避ける
- **必ずJSON形式で出力**（テキスト説明やテーブルは不要）
- 検証サマリー必須

よろしくお願いします。
"""
