"""
Grok Prompt v1.2 - Quality Over Hype Edition
実質重視版: バックテスト結果を反映した高精度選定

Created: 2025-11-06
Based on: v1_1_web_search.py + 6日間バックテスト分析
Description:
    - バックテスト分析により判明した失敗パターンを完全排除
    - 「バズを追わず、実質を追う」戦略
    - 前日大幅上昇（+10%以上）の銘柄を除外
    - Twitter過熱銘柄（「寄付狙い」100件以上）を除外
    - 実質的なIR材料（上方修正、受注、業績好転）を最重視
    - カテゴリは簡潔に（「株クラバズ」「仕手株」などの投機的ラベル禁止）

Backtest Results (6 days):
    - ネガティブパターン: 前日+10%以上 = 46.2%が失敗、Twitter「寄付狙い」バズ = 69.2%が失敗
    - ポジティブパターン: 実質的IR材料 = 平均+12.73%、カテゴリなし（質重視）= 7銘柄成功
"""

from typing import Any


def build_grok_prompt(context: dict[str, str], backtest: dict[str, Any]) -> str:
    """
    動的にGrokプロンプトを生成（Quality Over Hype版）

    Args:
        context: get_trading_context() で取得したコンテキスト
        backtest: load_backtest_patterns() で取得したバックテストデータ

    Returns:
        str: Grok APIに送信するプロンプト（実質重視版）
    """

    # バックテスト失敗パターン（ネガティブリスト）
    negative_patterns = """
【❌ 絶対避けるべきパターン（バックテスト実証済み）】

**バックテスト6日間の分析結果:**
- 失敗銘柄13銘柄の共通点を特定しました。以下のパターンに該当する銘柄は**絶対に選定しない**でください。

**1. 前日大幅上昇銘柄（高値掴みパターン）**
- **前日（{context['latest_trading_day']}）に+10%以上上昇した銘柄**
- バックテスト失敗率: **46.2%** (6/13銘柄)
- 典型例: 前日+16.8% → 翌日-18.53%、前日+14.8% → 翌日-13.52%
- web_searchで前日終値・騰落率を**必ず確認**し、+10%以上なら即除外

**2. Twitter過熱銘柄（バズ後の高値掴み）**
- 「寄付狙い」「デイトレ」「明日買い」の言及が**100件以上**
- バックテスト失敗率: **69.2%** (9/13銘柄)
- RT500超の大バズ = 全員が知っている = 遅すぎる
- x_searchで言及数を確認し、100件以上なら除外

**3. 失敗カテゴリの組み合わせ**
- 「IR好材料+株クラバズ」: -52,500円（勝率0%）
- 「バイオ材料+株クラバズ」: -11,200円（勝率0%）
- 「テーマ連動+仕手株」: -45,000円（1銘柄で大損失）
- カテゴリに「株クラバズ」「仕手株」を含めないこと

**4. 投機的ラベルの禁止**
- 「株クラバズ」「仕手株」「ストップ高狙い」などのカテゴリ名は使用禁止
- これらのラベルが付くこと自体が、過熱・投機的な銘柄の証拠
"""

    # バックテスト成功パターン（ポジティブリスト）
    positive_patterns = """
【✅ 優先すべきパターン（バックテスト実証済み）】

**バックテスト6日間の成功銘柄（+5%以上）:**
- 成功銘柄10銘柄の共通点を特定しました。以下のパターンを優先してください。

**1. 実質的なIR材料（最重要）**
- 上方修正（具体的な数値: 「経常利益+43.2%増」など）
- 受注発表（金額・顧客名・納期が明記されているもの）
- 業績好転（赤字→黒字、営業利益+30%以上）
- 成功例: 守谷商会（上方修正43.2%増 → +16.30%、+5.06%）

**2. 質重視の選定（カテゴリなし）**
- バックテスト平均リターン: **+12.73%** (7銘柄)
- 「株クラバズ」「仕手株」などの投機ラベルがない = 実質重視
- IR材料の質で選定され、バズは結果的についてきたもの

**3. 適度なバズ + 実質材料**
- ニュース材料が主、バズは補助的
- 成功例: M&A総研（M&Aニュース + 適度なバズ → +6.17%）
- 「適度」= 言及30-80件、RT100-400程度（100件超は過熱）

**4. カテゴリは簡潔に**
- 使用可: 「IR好材料」「決算好材料」「業績好転」
- 使用禁止: 「株クラバズ」「仕手株」「テーマ連動+仕手」
"""

    # バックテストセクション（統合版）
    backtest_section = ""
    if backtest.get('has_data'):
        backtest_section = f"""
【バックテスト結果フィードバック（直近5日間）】
**Phase1戦略（9:00寄付買い → 11:30前場引け売り）実績:**
- 勝率: **{backtest['phase1_success_rate']:.1f}%**
- 平均リターン: **{backtest['phase1_avg_return']:.2f}%**

**Phase2戦略（9:00寄付買い → 15:30大引け）実績:**
- 目標到達率: **{backtest.get('phase2_achievement_rate', 0):.1f}%**

{positive_patterns}
{negative_patterns}
"""
    else:
        backtest_section = f"""
【バックテスト結果】
※データ蓄積中のため、バックテスト結果は未提供です。
実質的なIR材料を重視し、Twitter過熱銘柄は避けてください。

{positive_patterns}
{negative_patterns}
"""

    return f"""【タスク】
本日は{context['execution_date']}です。
最新営業日は{context['latest_trading_day']}、翌営業日は{context['next_trading_day']}です。

**あなたは20年デイトレ専業の株アナリストです。**
**{context['next_trading_day']}の寄付〜前場でデイスキャルピング買い注文する銘柄**を10〜15銘柄選定し、JSON形式で出力してください。

**【重要】web_searchツールとx_searchツールを必ず使用して、一次情報を取得してください。**
- web_search: TDnet公式IR、ニュース記事（日経、株探、Yahoo!ファイナンス）
- x_search: X(旧Twitter)の言及確認（**ただし過熱銘柄は除外**）

{backtest_section}

【背景・目的】
私は以下2つのカテゴリで銘柄を運用しており、**これらでは拾えない「質の高い中小型株」**を探しています：

**既存カバー範囲（これらとの重複を避ける）:**
1. **Core30**: 日経平均主力・TOPIX Core30の超大型株（トヨタ、ソニー、三菱UFJなど）
2. **高配当・高市銘柄**: 防衛（三菱重工、川崎重工）、半導体（東京エレクトロン）、ロボット（ファナック、安川電機）、商社など

**求めている銘柄像（質の高い中小型株）:**
- **時価総額500億円以下の小型・中型株**
- **実質的なIR材料がある銘柄**（上方修正、受注発表、業績好転）
- **Twitter過熱前の銘柄**（バズは始まっているが、まだ100件未満）
- **{context['next_trading_day']}の寄付で買い→当日中に決済（デイトレ・スキャルピング）**

【選定基準（必須条件）】

**1. 実質的なIR材料（最重要）**
- **{context['latest_trading_day']}の引け後〜現在**に以下のいずれかの材料
  ✓ 上方修正（具体的な数値付き: 「経常利益+43.2%増」など）
  ✓ 受注発表（金額・顧客名・納期が明記されているもの）
  ✓ 業績好転（赤字→黒字、営業利益+30%以上）
  ✓ 新製品・サービス（売上見込み・時期が明記されているもの）

- **web_searchツールでIR・ニュースを確認:**
  ```
  # ニュースサイト経由でIR情報取得（優先順）
  site:nikkei.com [銘柄名] (上方修正 OR 受注 OR 業績) after:{context['latest_trading_day_raw']}
  site:finance.yahoo.co.jp [銘柄名] 適時開示
  site:kabutan.jp [銘柄名] IR
  [企業名] IR ニュースリリース after:{context['latest_trading_day_raw']}
  ```

**2. 前日騰落率の確認（ネガティブチェック）**
- **{context['latest_trading_day']}の騰落率が+10%未満であること**
- web_searchで前日終値・騰落率を**必ず確認**:
  ```
  site:yahoo.co.jp [銘柄名] 株価 {context['latest_trading_day_raw']}
  site:kabutan.jp [銘柄名] 株価 {context['latest_trading_day_raw']}
  ```
- +10%以上なら**即除外**（高値掴みリスク）

**3. Twitter言及の適度な確認（過熱チェック）**
- x_searchツールで言及数を確認:
  ```
  [銘柄名 OR ティッカーコード] since:{context['latest_trading_day_raw']}
  (注目 OR IR OR 決算)
  ```
- **言及30-80件程度が理想**（材料への反応、まだ過熱前）
- **言及100件以上は除外**（既に全員が知っている = 遅い）
- 「寄付狙い」「デイトレ」「明日買い」の言及が多い = 過熱サイン

**4. ボラティリティ（必須）**
- **{context['latest_trading_day']}またはその前後数日**の値動きが活発
- 直近5日のATR（Average True Range）≧ 3%
- {context['latest_trading_day']}の値幅（高値-安値）÷始値 ≧ 2%

**5. 出来高急増（流動性確保）**
- **{context['latest_trading_day']}**の出来高が20日平均の2倍以上
- 最低でも日次売買代金5000万円以上（約定可能性）

**6. 時価総額・市場（絞り込み）**
- **時価総額: 50億円〜500億円を優先**（小型・中型株）
- 市場: 東証プライム・スタンダード・グロース
- web_searchで時価総額を確認:
  ```
  site:yahoo.co.jp [銘柄名] 時価総額
  ```

【除外条件（厳守）】
以下は**絶対に選定しない**でください：

**基本除外（v1.1から継承）:**
- 日経225採用銘柄
- TOPIX Core30銘柄
- 時価総額1000億円以上の大型株
- 日次売買代金1000万円未満の低流動性銘柄
- 上場廃止銘柄または上場廃止予定の銘柄

**バックテスト判明の除外（v1.2新規）:**
- **前日（{context['latest_trading_day']}）に+10%以上上昇した銘柄**
- **Twitter言及が100件以上の過熱銘柄**
- **「寄付狙い」「デイトレ」「明日買い」の言及が多い銘柄**
- **RT500超の大バズ銘柄**

【ハルシネーション防止ルール（厳守）】

**絶対禁止事項:**
- ❌ ツール結果にない情報の推定・仮定・想像による生成
- ❌ 架空のURL・数値・銘柄名・IR情報の捏造
- ❌ 「おそらく」「推定」「可能性がある」「〜と思われる」などの曖昧表現
- ❌ ツール未実行での事実主張（必ずweb_search/x_searchで確認）

**必須事項:**
- ✅ 全ての事実（時価総額、出来高、ATR、前日騰落率、IR情報）はweb_search/x_searchの結果から**直接引用のみ**
- ✅ reasonフィールドにツール結果を引用形式で明記:
  - 例: `[web_search: Yahoo!ファイナンス]時価総額350億円、前日終値1,500円（+2.5%）`
  - 例: `[web_search: 日経新聞]経常利益43.2%増の上方修正IR発表(2025-10-31 15:30配信)`
  - 例: `[x_search: IR言及]言及45件確認（RT合計120、過熱前）`
- ✅ 前日騰落率を必ず明記（「前日+2.5%、+10%未満OK」など）
- ✅ Twitter言及数を必ず明記（「言及45件、100件未満OK」など）

【選定プロセス（5ステップ・Chain of Thought）】
以下の5ステップで選定してください。各ステップでweb_search/x_searchを**必ず実行**し、結果を引用形式でreasonに反映してください。

**ステップ1: IR材料検索**
- web_searchで{context['latest_trading_day']}引け後〜現在のIR・ニュース確認
- 上方修正、受注、業績好転などの実質材料がある銘柄をリストアップ
- 具体的な数値が明記されているものを優先

**ステップ2: 前日騰落率チェック（ネガティブフィルタ）**
- 各銘柄の{context['latest_trading_day']}騰落率をweb_searchで確認
- +10%以上の銘柄は即除外（高値掴みリスク）

**ステップ3: Twitter言及チェック（過熱フィルタ）**
- x_searchで言及数を確認
- 100件以上は除外（過熱済み）
- 「寄付狙い」「デイトレ」が多い = 過熱サイン

**ステップ4: 時価総額・流動性確認**
- web_searchで時価総額・市場を確認（50-500億円）
- 出来高2倍以上、ATR≧3%を確認

**ステップ5: 最終検証**
- 重複ゼロ確認
- 除外条件全チェック
- カテゴリに「株クラバズ」「仕手株」が含まれていないか確認

【出力形式（厳守）】
以下のJSON配列形式で出力してください（他の形式は不可）：

```json
[
  {{
    "ticker_symbol": "1798",
    "stock_name": "守谷商会",
    "reason": "[web_search: 日経新聞]{context['latest_trading_day']} 15:30配信、第2四半期決算上方修正IR発表（経常利益+43.2%増、具体的数値あり）。[web_search: Yahoo!ファイナンス]時価総額145億円、前日終値552円（+2.8%、+10%未満OK）。[x_search: IR言及]言及48件確認（RT180、「好決算」中心、過熱前）。[web_search: 株探]出来高20日平均の2.5倍、ATR 4.1%。地熱・核融合テーマ。除外確認: Core30リスト照合済み、前日+10%未満OK、言及100件未満OK",
    "categories": "IR好材料",
    "sentiment_score": 0.75,
    "policy_link": "Med",
    "previous_day_change_pct": 2.8,
    "twitter_mentions": 48
  }},
  {{
    "ticker_symbol": "9552",
    "stock_name": "M&A総研ホールディングス",
    "reason": "[web_search: Bloomberg]{context['latest_trading_day']} 17:00配信、大型M&A案件受注ニュース（案件規模50億円）。[web_search: Yahoo!]時価総額250億円、前日終値1,265円（+5.2%、+10%未満OK）。[x_search: M&A言及]言及65件（RT250、ニュース反応中心）。[web_search: 株探]出来高2.1倍、ATR 4.5%。除外確認: 前日+10%未満OK、言及100件未満OK",
    "categories": "決算好材料",
    "sentiment_score": 0.70,
    "policy_link": "Low",
    "previous_day_change_pct": 5.2,
    "twitter_mentions": 65
  }}
]
```

**JSON末尾に検証サマリーオブジェクトを追加:**
```json
{{
  "verification_summary": {{
    "total_stocks": 12,
    "avg_market_cap": "200億円",
    "duplicates": 0,
    "excluded_high_gain_stocks": 3,
    "excluded_overhyped_stocks": 2,
    "avg_previous_day_change": "+4.2%",
    "avg_twitter_mentions": 52,
    "avg_sentiment_score": 0.68
  }}
}}
```

**フィールドの説明:**
- **ticker_symbol**: 4桁の数字のみ（例: "1798"）。".T"は不要
- **reason**: 選定理由（必ず具体的な数値とツール引用を含める）
  - **IR材料の具体的な数値を必ず含める**（「経常利益+43.2%増」など）
  - **前日騰落率を必ず明記**（「前日+2.8%、+10%未満OK」など）
  - **Twitter言及数を必ず明記**（「言及48件、100件未満OK」など）
  - ツール引用形式: `[web_search: ソース名]事実内容`、`[x_search: キーワード]結果`
  - 除外確認明記（「除外確認: 前日+10%未満OK、言及100件未満OK」）
- **category**: カテゴリ（使用可: 「IR好材料」「決算好材料」「業績好転」のみ）
  - **使用禁止**: 「株クラバズ」「仕手株」「テーマ連動+仕手」などの投機ラベル
- **sentiment_score**: センチメントスコア（0.0-1.0）
  - 0.7-0.9: 強い（実質的な好材料、適度なバズ）
  - 0.5-0.7: 中程度（材料あり、一定の注目）
  - **0.9-1.0は使用しない**（過熱リスク高い）
- **policy_link**: 政府政策・テーマとのリンク強度
  - "High": 政府の重点政策（半導体、AI、防衛、GX）の中核銘柄
  - "Med": 政策テーマに関連するが周辺銘柄
  - "Low": 政策との直接的な関連なし
- **previous_day_change_pct**: 前日（{context['latest_trading_day']}）の騰落率（%）**必須フィールド**
- **twitter_mentions**: Twitter言及数（概算）**必須フィールド**

【検証前チェック（出力前必須）】
生成後、以下をチェックしてください。未達なら再生成:
- ✅ 重複: ticker_symbol重複なし
- ✅ 前日騰落率: 全銘柄+10%未満
- ✅ Twitter言及: 全銘柄100件未満
- ✅ カテゴリ: 「株クラバズ」「仕手株」含まず
- ✅ 除外: Core30/高配当大型/時価総額非該当を全確認
- ✅ 銘柄数: 10〜15銘柄
- ✅ reason品質: IR材料の具体的数値、前日騰落率、Twitter言及数を全含む
- ✅ センチメント平均: 0.5〜0.8（0.9以上は過熱リスク）

【注意事項】
- **web_searchツールとx_searchツールを積極的に使用**してください
- web_search例:
  - `site:nikkei.com [銘柄名] (上方修正 OR 受注) after:{context['latest_trading_day_raw']}`
  - `site:finance.yahoo.co.jp [銘柄名] 株価 {context['latest_trading_day_raw']}`
  - `site:kabutan.jp [銘柄名] IR`
- x_search例:
  - `[銘柄名] since:{context['latest_trading_day_raw']} (注目 OR IR OR 決算)`
  - 言及数を数えて、100件以上なら除外
- **{context['latest_trading_day']}の引け後〜現在の材料・前日騰落率を重視**
- reasonには必ず一次情報のURL含める（日経、Yahoo!、株探など）
- 前日騰落率・Twitter言及数を必ずreasonに明記
- カテゴリに投機的ラベル（「株クラバズ」「仕手株」）は使わない
- 除外条件厳守、重複絶対避ける
- **必ずJSON形式で出力**（テキスト説明やテーブルは不要）
- 検証サマリー必須

よろしくお願いします。
"""
