<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatterjee相関係数 - 新しい相関の測定方法</title>
    <style>
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f2e;
            --bg-card: #1e2433;
            --text-primary: #e4e6eb;
            --text-secondary: #8b919e;
            --accent: #4d8bff;
            --success: #2ecc94;
            --warning: #f5a623;
            --danger: #f06563;
            --border: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.8;
            padding: 2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        h2 {
            font-size: 1.25rem;
            margin: 2rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            color: var(--accent);
        }

        h3 {
            font-size: 1rem;
            margin: 1.5rem 0 0.75rem;
            color: var(--text-primary);
        }

        p {
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .meta {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .formula {
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent);
            padding: 1rem 1.5rem;
            margin: 1rem 0;
            font-family: "SF Mono", "Consolas", monospace;
            font-size: 1.1rem;
            overflow-x: auto;
        }

        .formula-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        code {
            background: var(--bg-secondary);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: "SF Mono", "Consolas", monospace;
            font-size: 0.9em;
        }

        pre {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        pre code {
            background: none;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.875rem;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .highlight {
            color: var(--accent);
        }

        .success { color: var(--success); }
        .warning { color: var(--warning); }
        .danger { color: var(--danger); }

        ul, ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
            color: var(--text-secondary);
        }

        li {
            margin: 0.5rem 0;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .comparison-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }

        .comparison-item h4 {
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(46, 204, 148, 0.2);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 166, 35, 0.2);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(240, 101, 99, 0.2);
            color: var(--danger);
        }

        .use-case {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .use-case-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border), transparent);
            margin: 3rem 0;
        }

        a {
            color: var(--accent);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .references {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chatterjee相関係数</h1>
        <p class="meta">
            新しい相関の測定方法 - 非線形関係を検出できる革新的な指標<br>
            Chatterjee, S. (2021). "A new coefficient of correlation." Journal of the American Statistical Association, 116(536), 2009-2022.
        </p>

        <h2>1. 概要</h2>
        <p>
            Stanford大学のSourav Chatterjee教授が2021年に提案した新しい相関係数 <strong>ξ（クサイ）</strong> は、
            従来のピアソン相関係数やスピアマン順位相関係数では検出できない<span class="highlight">非線形の依存関係</span>を捉えることができます。
        </p>

        <div class="card">
            <h3>主な特徴</h3>
            <ul>
                <li><strong>ξ = 0</strong> ⟺ X と Y が<span class="highlight">独立</span></li>
                <li><strong>ξ = 1</strong> ⟺ Y が X の<span class="highlight">関数</span>（Y = f(X)）</li>
                <li>非線形関係（Y = X², sin(X) など）を検出可能</li>
                <li>外れ値に強い（順位ベース）</li>
                <li>計算効率が良い O(n log n)</li>
            </ul>
        </div>

        <h2>2. 従来の相関係数との比較</h2>

        <div class="comparison-grid">
            <div class="comparison-item">
                <h4>ピアソン相関係数</h4>
                <p style="font-size: 0.875rem; margin-bottom: 0.5rem;">線形関係のみ検出</p>
                <span class="badge badge-danger">Y=X² → r≈0</span>
            </div>
            <div class="comparison-item">
                <h4>スピアマン順位相関</h4>
                <p style="font-size: 0.875rem; margin-bottom: 0.5rem;">単調関係まで検出</p>
                <span class="badge badge-warning">Y=sin(X) → ρ≈0</span>
            </div>
            <div class="comparison-item">
                <h4>Chatterjee相関 ξ</h4>
                <p style="font-size: 0.875rem; margin-bottom: 0.5rem;">任意の関数関係を検出</p>
                <span class="badge badge-success">Y=f(X) → ξ≈1</span>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>関係性</th>
                    <th>ピアソン r</th>
                    <th>スピアマン ρ</th>
                    <th>Chatterjee ξ</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Y = X（線形）</td>
                    <td class="success">1.0</td>
                    <td class="success">1.0</td>
                    <td class="success">1.0</td>
                </tr>
                <tr>
                    <td>Y = X²（二次関数）</td>
                    <td class="danger">≈ 0</td>
                    <td class="warning">≈ 0.5</td>
                    <td class="success">≈ 1.0</td>
                </tr>
                <tr>
                    <td>Y = sin(X)</td>
                    <td class="danger">≈ 0</td>
                    <td class="danger">≈ 0</td>
                    <td class="success">≈ 1.0</td>
                </tr>
                <tr>
                    <td>X, Y 独立</td>
                    <td>≈ 0</td>
                    <td>≈ 0</td>
                    <td>≈ 0</td>
                </tr>
            </tbody>
        </table>

        <h2>3. 数学的定義</h2>

        <div class="formula">
            <div class="formula-label">Chatterjee相関係数 ξₙ(X, Y)</div>
            ξₙ = 1 - (3 × Σ|rᵢ₊₁ - rᵢ|) / (n² - 1)
        </div>

        <p>ここで：</p>
        <ul>
            <li><strong>n</strong>: サンプルサイズ</li>
            <li><strong>rᵢ</strong>: X の値で昇順ソートした後の、i番目のデータ点における Y の順位</li>
            <li><strong>Σ|rᵢ₊₁ - rᵢ|</strong>: 隣接する Y の順位の差の絶対値の総和</li>
        </ul>

        <h3>直感的な理解</h3>
        <div class="card">
            <p>
                X でソートした時、Y に何らかの関係があれば「隣り合う点の Y の値は近いはず」という原理に基づきます。
            </p>
            <ul>
                <li>Y = f(X) の関係がある場合 → 隣接順位の差が小さい → ξ ≈ 1</li>
                <li>X と Y が独立な場合 → 隣接順位の差がランダム → ξ ≈ 0</li>
            </ul>
        </div>

        <h2>4. 計算アルゴリズム</h2>

        <ol>
            <li>データを (X, Y) のペアとして準備</li>
            <li>X の値で昇順にソート</li>
            <li>ソート後の Y の順位（rank）を計算</li>
            <li>隣接する順位の差の絶対値の総和を計算</li>
            <li>上記の式で ξ を計算</li>
        </ol>

        <h3>Python実装</h3>
        <pre><code>import numpy as np
from scipy.stats import rankdata

def chatterjee_correlation(x, y):
    """
    Chatterjee相関係数を計算

    Parameters:
    -----------
    x, y : array-like
        相関を計算する2つの変数

    Returns:
    --------
    float : Chatterjee相関係数 ξ（0〜1の値）
    """
    n = len(x)
    if n != len(y):
        raise ValueError("x と y の長さが一致しません")

    # X でソートした時の Y のインデックス
    order = np.argsort(x)
    y_sorted = np.array(y)[order]

    # Y の順位を計算
    ranks = rankdata(y_sorted, method='average')

    # 隣接順位の差の絶対値の総和
    rank_diff_sum = np.sum(np.abs(np.diff(ranks)))

    # Chatterjee相関係数
    xi = 1 - (3 * rank_diff_sum) / (n**2 - 1)

    return xi


# 使用例
if __name__ == "__main__":
    np.random.seed(42)
    n = 1000

    # 線形関係
    x = np.random.uniform(-1, 1, n)
    y_linear = x + np.random.normal(0, 0.1, n)
    print(f"線形関係 Y=X+ε: ξ = {chatterjee_correlation(x, y_linear):.3f}")

    # 二次関数関係
    y_quadratic = x**2 + np.random.normal(0, 0.1, n)
    print(f"二次関係 Y=X²+ε: ξ = {chatterjee_correlation(x, y_quadratic):.3f}")

    # 正弦関数関係
    y_sin = np.sin(2 * np.pi * x) + np.random.normal(0, 0.1, n)
    print(f"正弦関係 Y=sin(X)+ε: ξ = {chatterjee_correlation(x, y_sin):.3f}")

    # 独立
    y_independent = np.random.normal(0, 1, n)
    print(f"独立: ξ = {chatterjee_correlation(x, y_independent):.3f}")</code></pre>

        <h2>5. 統計的性質</h2>

        <div class="card">
            <h3>漸近分布（独立性の仮定下）</h3>
            <p>
                X と Y が独立な場合、n → ∞ で：
            </p>
            <div class="formula">
                √n × ξₙ → N(0, 2/5)
            </div>
            <p>
                これにより、独立性の検定が可能です。有意水準 α での棄却域は：
            </p>
            <div class="formula">
                ξₙ > z_{1-α} × √(2 / 5n)
            </div>
        </div>

        <h2>6. 株式分析への応用可能性</h2>

        <div class="use-case">
            <div class="use-case-title">
                <span class="badge badge-success">高</span>
                テクニカル指標と株価リターンの関係分析
            </div>
            <p>
                RSI、MACD、ボリンジャーバンドなどのテクニカル指標と翌日リターンの間には、
                線形でない複雑な関係が存在する可能性があります。Chatterjee相関を使うことで、
                従来の相関分析では見つからなかった予測力を発見できる可能性があります。
            </p>
        </div>

        <div class="use-case">
            <div class="use-case-title">
                <span class="badge badge-success">高</span>
                ボラティリティと株価変動の非線形関係
            </div>
            <p>
                VIX（恐怖指数）と株価の関係は、単純な線形関係ではありません。
                極端な恐怖時には株価が急落し、通常時には関係が弱いという非対称性があります。
                Chatterjee相関はこのような非線形パターンを検出できます。
            </p>
        </div>

        <div class="use-case">
            <div class="use-case-title">
                <span class="badge badge-warning">中</span>
                セクター間の依存関係分析
            </div>
            <p>
                異なるセクター間の依存関係は、市場環境によって変化します。
                平常時には独立に見えても、危機時には強く連動することがあります。
                時系列でChatterjee相関を監視することで、市場構造の変化を検出できます。
            </p>
        </div>

        <div class="use-case">
            <div class="use-case-title">
                <span class="badge badge-warning">中</span>
                マクロ経済指標と株価の関係
            </div>
            <p>
                金利、インフレ率、GDP成長率などのマクロ指標と株価の関係は、
                閾値効果やレジーム変化を含む複雑な構造を持ちます。
                Chatterjee相関は、このような非単調な関係を検出するのに適しています。
            </p>
        </div>

        <div class="section-divider"></div>

        <h2>7. 現行システムへの組み込み案</h2>

        <h3>7.1 バックエンド（Python/FastAPI）</h3>
        <pre><code># server/services/correlation_service.py

import numpy as np
from scipy.stats import rankdata, pearsonr, spearmanr

class CorrelationService:
    @staticmethod
    def chatterjee_correlation(x: np.ndarray, y: np.ndarray) -> float:
        """Chatterjee相関係数を計算"""
        n = len(x)
        order = np.argsort(x)
        y_sorted = y[order]
        ranks = rankdata(y_sorted, method='average')
        rank_diff_sum = np.sum(np.abs(np.diff(ranks)))
        return 1 - (3 * rank_diff_sum) / (n**2 - 1)

    @staticmethod
    def all_correlations(x: np.ndarray, y: np.ndarray) -> dict:
        """3種類の相関係数を一括計算"""
        return {
            "pearson": pearsonr(x, y)[0],
            "spearman": spearmanr(x, y)[0],
            "chatterjee": CorrelationService.chatterjee_correlation(x, y)
        }

    @staticmethod
    def correlation_matrix(data: dict, method: str = "chatterjee") -> np.ndarray:
        """複数変数間の相関行列を計算"""
        keys = list(data.keys())
        n = len(keys)
        matrix = np.zeros((n, n))

        for i in range(n):
            for j in range(n):
                if i == j:
                    matrix[i, j] = 1.0
                else:
                    x = np.array(data[keys[i]])
                    y = np.array(data[keys[j]])
                    if method == "chatterjee":
                        matrix[i, j] = CorrelationService.chatterjee_correlation(x, y)
                    elif method == "pearson":
                        matrix[i, j] = pearsonr(x, y)[0]
                    elif method == "spearman":
                        matrix[i, j] = spearmanr(x, y)[0]

        return matrix</code></pre>

        <h3>7.2 APIエンドポイント</h3>
        <pre><code># server/routers/correlation.py

from fastapi import APIRouter, Query
from typing import List, Optional

router = APIRouter(prefix="/api/correlation", tags=["correlation"])

@router.get("/indicators")
async def get_indicator_correlations(
    ticker: str,
    period: int = Query(default=60, description="分析期間（日）"),
    target: str = Query(default="next_day_return", description="目的変数")
):
    """
    テクニカル指標と株価リターンの相関分析

    Returns:
        各指標との3種類の相関係数（ピアソン、スピアマン、Chatterjee）
    """
    # 実装...
    pass

@router.get("/matrix")
async def get_correlation_matrix(
    tickers: List[str] = Query(...),
    period: int = Query(default=60),
    method: str = Query(default="chatterjee")
):
    """
    複数銘柄間の相関行列
    """
    # 実装...
    pass</code></pre>

        <h3>7.3 フロントエンド表示案</h3>
        <p>
            推奨銘柄ページや個別銘柄ページに、テクニカル指標との相関分析セクションを追加：
        </p>
        <ul>
            <li>指標ごとに3種類の相関係数を表示</li>
            <li>Chatterjee相関が高いが、ピアソン相関が低い指標をハイライト（非線形関係の発見）</li>
            <li>相関行列のヒートマップ表示</li>
        </ul>

        <div class="section-divider"></div>

        <h2>8. まとめ</h2>

        <div class="card">
            <h3>Chatterjee相関係数の利点</h3>
            <ul>
                <li>✅ 非線形関係を検出可能（従来手法の限界を克服）</li>
                <li>✅ 解釈が明確（0=独立、1=関数関係）</li>
                <li>✅ 外れ値に強い（順位ベース）</li>
                <li>✅ 計算効率が良い O(n log n)</li>
                <li>✅ 漸近正規性により統計検定が可能</li>
            </ul>

            <h3 style="margin-top: 1.5rem;">株式分析への適用</h3>
            <ul>
                <li>✅ テクニカル指標の予測力評価に有効</li>
                <li>✅ 市場構造の変化検出に利用可能</li>
                <li>✅ 既存のPythonバックエンドに容易に組み込み可能</li>
                <li>⚠️ 方向性（正/負の関係）は示さない点に注意</li>
            </ul>
        </div>

        <div class="section-divider"></div>

        <h2>参考文献</h2>
        <div class="references">
            <ol>
                <li>
                    Chatterjee, S. (2021). "A new coefficient of correlation."
                    <em>Journal of the American Statistical Association</em>, 116(536), 2009-2022.
                    <a href="https://arxiv.org/abs/1909.10140" target="_blank">arXiv</a> |
                    <a href="https://www.tandfonline.com/doi/full/10.1080/01621459.2020.1758115" target="_blank">Publisher</a>
                </li>
                <li>
                    Qiita記事: 「新しい相関係数の紹介」
                    <a href="https://qiita.com/Islay_tr/items/dd427ba86ba11bd25626" target="_blank">Link</a>
                </li>
                <li>
                    XICOR: R package for computing Chatterjee's correlation
                    <a href="https://cran.r-project.org/package=XICOR" target="_blank">CRAN</a>
                </li>
            </ol>
        </div>

        <p style="margin-top: 3rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">
            作成日: 2025-12-06
        </p>
    </div>
</body>
</html>
