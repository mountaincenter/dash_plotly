<mxfile host="app.diagrams.net" modified="2025-10-25T12:00:00.000Z" agent="Claude" version="22.0.0" type="device">
  <diagram name="AWS Architecture" id="aws-stock-api">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="900" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="AWS Stock API Infrastructure (Terraform Managed)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=24;fontStyle=1;fontColor=#232F3E;" vertex="1" parent="1">
          <mxGeometry x="400" y="20" width="600" height="40" as="geometry" />
        </mxCell>

        <!-- GitHub Actions Section -->
        <mxCell id="github-box" value="GitHub Actions" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#4CAF50;align=left;verticalAlign=top;fontSize=14;fontStyle=1;spacingLeft=10;spacingTop=5;" vertex="1" parent="1">
          <mxGeometry x="60" y="100" width="280" height="200" as="geometry" />
        </mxCell>

        <mxCell id="data-pipeline" value="Data Pipeline&#xa;(毎日16:00/26:00 JST)&#xa;&#xa;• J-Quants API&#xa;• yFinance&#xa;• Grok AI分析" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#4CAF50;fontSize=11;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="80" y="140" width="240" height="70" as="geometry" />
        </mxCell>

        <mxCell id="ecr-deploy" value="ECR Deploy&#xa;(コード変更時)&#xa;&#xa;• Docker Build&#xa;• ECR Push" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#4CAF50;fontSize=11;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="80" y="220" width="240" height="70" as="geometry" />
        </mxCell>

        <!-- AWS Cloud Section -->
        <mxCell id="aws-cloud" value="AWS Cloud" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#FF9800;align=left;verticalAlign=top;fontSize=14;fontStyle=1;spacingLeft=10;spacingTop=5;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="400" y="100" width="900" height="500" as="geometry" />
        </mxCell>

        <!-- S3 Bucket -->
        <mxCell id="s3" value="Amazon S3&#xa;stock-api-data&#xa;&#xa;• parquet/*&#xa;• meta_jquants.parquet&#xa;• prices_max_1d.parquet&#xa;• grok_trending.parquet&#xa;• all_stocks.parquet" style="sketch=0;points=[[0,0,0],[0.25,0,0],[0.5,0,0],[0.75,0,0],[1,0,0],[0,1,0],[0.25,1,0],[0.5,1,0],[0.75,1,0],[1,1,0],[0,0.25,0],[0,0.5,0],[0,0.75,0],[1,0.25,0],[1,0.5,0],[1,0.75,0]];outlineConnect=0;fontColor=#232F3E;gradientColor=#60A337;gradientDirection=north;fillColor=#277116;strokeColor=#ffffff;dashed=0;verticalLabelPosition=bottom;verticalAlign=top;align=center;html=1;fontSize=11;fontStyle=0;aspect=fixed;shape=mxgraph.aws4.resourceIcon;resIcon=mxgraph.aws4.s3;" vertex="1" parent="1">
          <mxGeometry x="450" y="150" width="78" height="78" as="geometry" />
        </mxCell>

        <!-- ECR -->
        <mxCell id="ecr" value="Amazon ECR&#xa;stock-api&#xa;&#xa;• latest tag&#xa;• &lt;git-sha&gt; tag&#xa;• Auto Scan" style="sketch=0;points=[[0,0,0],[0.25,0,0],[0.5,0,0],[0.75,0,0],[1,0,0],[0,1,0],[0.25,1,0],[0.5,1,0],[0.75,1,0],[1,1,0],[0,0.25,0],[0,0.5,0],[0,0.75,0],[1,0.25,0],[1,0.5,0],[1,0.75,0]];outlineConnect=0;fontColor=#232F3E;gradientColor=#F78E04;gradientDirection=north;fillColor=#D05C17;strokeColor=#ffffff;dashed=0;verticalLabelPosition=bottom;verticalAlign=top;align=center;html=1;fontSize=11;fontStyle=0;aspect=fixed;shape=mxgraph.aws4.resourceIcon;resIcon=mxgraph.aws4.ecr;" vertex="1" parent="1">
          <mxGeometry x="620" y="150" width="78" height="78" as="geometry" />
        </mxCell>

        <!-- App Runner -->
        <mxCell id="apprunner" value="AWS App Runner&#xa;stock-api&#xa;&#xa;• CPU: 1024&#xa;• Memory: 2048&#xa;• Auto Deploy: ON" style="sketch=0;points=[[0,0,0],[0.25,0,0],[0.5,0,0],[0.75,0,0],[1,0,0],[0,1,0],[0.25,1,0],[0.5,1,0],[0.75,1,0],[1,1,0],[0,0.25,0],[0,0.5,0],[0,0.75,0],[1,0.25,0],[1,0.5,0],[1,0.75,0]];outlineConnect=0;fontColor=#232F3E;gradientColor=#F78E04;gradientDirection=north;fillColor=#D05C17;strokeColor=#ffffff;dashed=0;verticalLabelPosition=bottom;verticalAlign=top;align=center;html=1;fontSize=11;fontStyle=0;aspect=fixed;shape=mxgraph.aws4.resourceIcon;resIcon=mxgraph.aws4.app_runner;" vertex="1" parent="1">
          <mxGeometry x="790" y="150" width="78" height="78" as="geometry" />
        </mxCell>

        <!-- Route53 -->
        <mxCell id="route53" value="Route 53&#xa;api.ymnk.jp&#xa;&#xa;stock.api.ymnk.jp" style="sketch=0;points=[[0,0,0],[0.25,0,0],[0.5,0,0],[0.75,0,0],[1,0,0],[0,1,0],[0.25,1,0],[0.5,1,0],[0.75,1,0],[1,1,0],[0,0.25,0],[0,0.5,0],[0,0.75,0],[1,0.25,0],[1,0.5,0],[1,0.75,0]];outlineConnect=0;fontColor=#232F3E;gradientColor=#945DF2;gradientDirection=north;fillColor=#5A30B5;strokeColor=#ffffff;dashed=0;verticalLabelPosition=bottom;verticalAlign=top;align=center;html=1;fontSize=11;fontStyle=0;aspect=fixed;shape=mxgraph.aws4.resourceIcon;resIcon=mxgraph.aws4.route_53;" vertex="1" parent="1">
          <mxGeometry x="960" y="150" width="78" height="78" as="geometry" />
        </mxCell>

        <!-- EventBridge -->
        <mxCell id="eventbridge" value="EventBridge&#xa;apprunner-&#xa;deployment-&#xa;to-slack" style="sketch=0;points=[[0,0,0],[0.25,0,0],[0.5,0,0],[0.75,0,0],[1,0,0],[0,1,0],[0.25,1,0],[0.5,1,0],[0.75,1,0],[1,1,0],[0,0.25,0],[0,0.5,0],[0,0.75,0],[1,0.25,0],[1,0.5,0],[1,0.75,0]];outlineConnect=0;fontColor=#232F3E;gradientColor=#FF4F8B;gradientDirection=north;fillColor=#BC1356;strokeColor=#ffffff;dashed=0;verticalLabelPosition=bottom;verticalAlign=top;align=center;html=1;fontSize=11;fontStyle=0;aspect=fixed;shape=mxgraph.aws4.resourceIcon;resIcon=mxgraph.aws4.eventbridge;" vertex="1" parent="1">
          <mxGeometry x="790" y="350" width="78" height="78" as="geometry" />
        </mxCell>

        <!-- Lambda -->
        <mxCell id="lambda" value="Lambda&#xa;apprunner-&#xa;deployment-&#xa;notification" style="sketch=0;points=[[0,0,0],[0.25,0,0],[0.5,0,0],[0.75,0,0],[1,0,0],[0,1,0],[0.25,1,0],[0.5,1,0],[0.75,1,0],[1,1,0],[0,0.25,0],[0,0.5,0],[0,0.75,0],[1,0.25,0],[1,0.5,0],[1,0.75,0]];outlineConnect=0;fontColor=#232F3E;gradientColor=#F78E04;gradientDirection=north;fillColor=#D05C17;strokeColor=#ffffff;dashed=0;verticalLabelPosition=bottom;verticalAlign=top;align=center;html=1;fontSize=11;fontStyle=0;aspect=fixed;shape=mxgraph.aws4.resourceIcon;resIcon=mxgraph.aws4.lambda;" vertex="1" parent="1">
          <mxGeometry x="960" y="350" width="78" height="78" as="geometry" />
        </mxCell>

        <!-- IAM Section -->
        <mxCell id="iam-box" value="IAM Roles" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#F44336;align=left;verticalAlign=top;fontSize=12;fontStyle=1;spacingLeft=10;spacingTop=5;" vertex="1" parent="1">
          <mxGeometry x="450" y="470" width="340" height="110" as="geometry" />
        </mxCell>

        <mxCell id="iam-roles" value="• AppRunnerECRAccessRole-stock-api&#xa;• AppRunnerInstanceRole-stock-api (S3 Read)&#xa;• apprunner-notification-lambda-role&#xa;• GitHubActions-DashPlotly (OIDC)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="460" y="500" width="320" height="70" as="geometry" />
        </mxCell>

        <!-- External Services -->
        <mxCell id="slack" value="Slack&#xa;Webhook" style="sketch=0;outlineConnect=0;fontColor=#232F3E;gradientColor=none;fillColor=#232F3D;strokeColor=#ffffff;dashed=0;verticalLabelPosition=bottom;verticalAlign=top;align=center;html=1;fontSize=12;fontStyle=0;aspect=fixed;pointerEvents=1;shape=mxgraph.aws4.traditional_server;" vertex="1" parent="1">
          <mxGeometry x="1200" y="350" width="48" height="83" as="geometry" />
        </mxCell>

        <mxCell id="users" value="Users&#xa;HTTPS API" style="sketch=0;outlineConnect=0;fontColor=#232F3E;gradientColor=none;fillColor=#232F3D;strokeColor=#ffffff;dashed=0;verticalLabelPosition=bottom;verticalAlign=top;align=center;html=1;fontSize=12;fontStyle=0;aspect=fixed;pointerEvents=1;shape=mxgraph.aws4.users;" vertex="1" parent="1">
          <mxGeometry x="1130" y="165" width="48" height="48" as="geometry" />
        </mxCell>

        <!-- Arrows: GitHub → S3 -->
        <mxCell id="arrow-gh-s3" value="1. Upload Data" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;strokeColor=#4CAF50;strokeWidth=2;fontSize=11;" edge="1" parent="1" source="data-pipeline" target="s3">
          <mxGeometry x="-0.2" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="380" y="175" />
              <mxPoint x="380" y="189" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Arrows: GitHub → ECR -->
        <mxCell id="arrow-gh-ecr" value="2. Push Image" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;strokeColor=#4CAF50;strokeWidth=2;fontSize=11;" edge="1" parent="1" source="ecr-deploy" target="ecr">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="380" y="255" />
              <mxPoint x="380" y="189" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Arrows: ECR → App Runner -->
        <mxCell id="arrow-ecr-app" value="3. Auto Deploy&#xa;(auto_deployments_enabled)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;strokeColor=#FF9800;strokeWidth=3;fontSize=11;" edge="1" parent="1" source="ecr" target="apprunner">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Arrows: S3 → App Runner -->
        <mxCell id="arrow-s3-app" value="Read Data" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;strokeColor=#60A337;strokeWidth=2;dashed=1;fontSize=11;" edge="1" parent="1" source="s3" target="apprunner">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="489" y="120" />
              <mxPoint x="829" y="120" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Arrows: App Runner → Route53 -->
        <mxCell id="arrow-app-r53" value="Custom Domain" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;strokeColor=#945DF2;strokeWidth=2;fontSize=11;" edge="1" parent="1" source="apprunner" target="route53">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Arrows: Route53 → Users -->
        <mxCell id="arrow-r53-users" value="HTTPS" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;strokeColor=#232F3E;strokeWidth=2;fontSize=11;" edge="1" parent="1" source="route53" target="users">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Arrows: App Runner → EventBridge -->
        <mxCell id="arrow-app-eb" value="4. Deployment&#xa;Event" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;strokeColor=#BC1356;strokeWidth=2;fontSize=11;" edge="1" parent="1" source="apprunner" target="eventbridge">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="829" y="300" />
              <mxPoint x="829" y="300" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Arrows: EventBridge → Lambda -->
        <mxCell id="arrow-eb-lambda" value="5. Trigger" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;strokeColor=#BC1356;strokeWidth=2;fontSize=11;" edge="1" parent="1" source="eventbridge" target="lambda">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Arrows: Lambda → Slack -->
        <mxCell id="arrow-lambda-slack" value="6. Notify" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;strokeColor=#232F3E;strokeWidth=2;fontSize=11;" edge="1" parent="1" source="lambda" target="slack">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Legend -->
        <mxCell id="legend-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F5F5F5;strokeColor=#666666;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="60" y="650" width="600" height="180" as="geometry" />
        </mxCell>

        <mxCell id="legend-title" value="Infrastructure Details" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1;fontColor=#232F3E;" vertex="1" parent="1">
          <mxGeometry x="80" y="665" width="200" height="25" as="geometry" />
        </mxCell>

        <mxCell id="legend-terraform" value="✓ All resources managed by Terraform" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontColor=#4CAF50;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="700" width="250" height="20" as="geometry" />
        </mxCell>

        <mxCell id="legend-content" value="S3 Bucket: stock-api-data (3,790銘柄, プライム/スタンダード/グロース)&#xa;ECR: stock-api (latest + git-sha tags, lifecycle: 10 images)&#xa;App Runner: Auto Deploy ON, 1vCPU/2GB, Health Check TCP&#xa;Route53: api.ymnk.jp hosted zone, stock.api.ymnk.jp CNAME&#xa;EventBridge: Deployment event detection&#xa;Lambda: Python 3.12, Slack webhook notification&#xa;IAM: ECR access, S3 read-only, Lambda execution, GitHub OIDC" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=11;spacingLeft=5;" vertex="1" parent="1">
          <mxGeometry x="80" y="725" width="560" height="90" as="geometry" />
        </mxCell>

        <!-- Data Flow Info -->
        <mxCell id="dataflow-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#2196F3;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="700" y="650" width="600" height="180" as="geometry" />
        </mxCell>

        <mxCell id="dataflow-title" value="Data Pipeline Flow (Daily 16:00/26:00 JST)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1;fontColor=#232F3E;" vertex="1" parent="1">
          <mxGeometry x="720" y="665" width="350" height="25" as="geometry" />
        </mxCell>

        <mxCell id="dataflow-content" value="1. Check Trading Day (J-Quants API)&#xa;2. Fetch Data:&#xa;   • J-Quants: meta_jquants (3,790 stocks filtered)&#xa;   • yFinance: prices_max_1d&#xa;   • CSV: Core30 + Policy stocks → meta.parquet&#xa;3. AI Analysis: Grok trending selection (12 stocks)&#xa;4. Generate: all_stocks.parquet (combined data)&#xa;5. Upload to S3: stock-api-data/parquet/*&#xa;6. Backup: backtest/grok_trending_YYYYMMDD.parquet (7 days)&#xa;7. Slack Notification: Improved format (全銘柄表示)&#xa;8. Trigger ECR Deploy → App Runner Auto Deploy" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=11;spacingLeft=5;" vertex="1" parent="1">
          <mxGeometry x="720" y="695" width="560" height="125" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
