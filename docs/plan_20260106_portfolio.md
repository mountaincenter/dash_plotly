# 計画: テーマ銘柄再定義 + 母集団別統計分析

## タスク優先順位

1. **J-Quants v1→v2移行**（トッププライオリティ、引き継ぎファイル作成済み）
2. **Grokショート必要資金算出**（Part 3）
3. **テーマ銘柄再定義**（Part 1）← 余剰資金が確定してから
4. **母集団別統計分析**（Part 2）

---

# Part 1: テーマ銘柄再定義

## 背景

現在の政策銘柄（34銘柄）は2025年11月に高市政権誕生を想定して選定。
ゼロから再定義し、1ヶ月程度のロングでファンダメンタル中心の投資に活用する。

## 2026年 投資テーマ方針（シンクタンクレポート総括）

### 株価見通し
| 機関 | 日経平均 | TOPIX |
|------|----------|-------|
| 野村證券 | 55,000円 | 3,600 |
| 大和AM | 56,000円 | 3,750 |

### 国家戦略技術6分野（政府指定）
1. AI・先端ロボット
2. 量子
3. 半導体・通信
4. バイオ・ヘルスケア
5. フュージョンエネルギー（核融合）
6. 宇宙

### 高市政権17分野の主要テーマ
- 防衛・安全保障
- 造船
- レアアース・レアメタル
- 原子力（SMR含む）
- ペロブスカイト太陽電池
- 国土強靱化・インフラ

### 2026年注目トピック
| トピック | 関連セクター | 備考 |
|----------|-------------|------|
| **フィジカルAI** | ロボット、半導体 | 野村・大和・三菱UFJ全てが言及 |
| **地政学リスク** | 防衛、商社、エネルギー | ベネズエラ攻撃(1/3)で顕在化 |
| **金利上昇** | 銀行、保険 | 日銀利上げ継続見通し |
| **スポーツイベント** | エンタメ、建設、広告 | ミラノ五輪、WBC、北中米W杯 |
| **ステーブルコイン** | フィンテック | JPYC発行、ゆうちょDCJPY |
| **GX** | 再エネ、省エネ | 排出量取引制度本格稼働 |
| **ガバナンス改革** | 全般 | コーポレートガバナンス・コード改訂(26年半ば) |

### 回避セクター（野村證券）
- 鉄鋼
- 小売
- インバウンド関連

## 新カテゴリ体系（案）

### メインカテゴリ
```
TOPIX_CORE30     - 大型株ベンチマーク
テーマ銘柄        - 中長期ロング対象（旧: 政策銘柄）
Grok銘柄         - 短期ショート対象
```

### テーマ銘柄のタグ体系（案）
```
# 国策・政策
- 防衛・安全保障
- 半導体・先端技術
- エネルギー安全保障
- 経済安全保障
- インフラ・建設
- 宇宙
- 核融合

# トレンド
- フィジカルAI
- ステーブルコイン
- GX・脱炭素
- ペロブスカイト

# イベント
- スポーツイベント
- ガバナンス改革

# 地政学
- 地政学リスク（資源・防衛）
```

## 実装

### 対象ファイル
- 入力: `data/csv/takaichi_stock_issue.csv`（現行v1、56銘柄）
- 出力: `data/csv/takaichi_stock_issue_v2.csv`

### 現行タグ（v1）
- 高市銘柄
- 防衛・安全保障
- エネルギー安全保障
- 半導体・先端技術
- サイバーセキュリティ・デジタル
- 経済安全保障・サプライチェーン
- 宇宙産業
- 地方創生・社会政策

### 追加タグ（v2）
- フィジカルAI
- 核融合
- ステーブルコイン
- GX・脱炭素
- ペロブスカイト
- スポーツイベント
- ガバナンス改革
- 地政学リスク
- 造船
- バイオ・ヘルスケア
- 量子

### 銘柄追加候補
| テーマ | 銘柄例 | 備考 |
|--------|--------|------|
| フィジカルAI | 安川電機(6506)、ファナック(6954) | ロボット |
| 地政学・資源 | （既存に含む）| 三菱商事、三井物産等 |
| ステーブルコイン | アステリア(3853)、SBI HD(8473)、電算システムHD(4072) | 新規追加 |
| 核融合 | （既存に含む）| 三菱重工、IHI |
| ペロブスカイト | カネカ(4118)、パナソニック(6752) | 積水化学は既存 |
| 造船 | 三井E&S(7003)、名村造船(7014) | 国策17分野 |
| バイオ | 中外製薬(4519)、第一三共(4568) | 国策6分野 |
| スポーツイベント | 電通G(4324)、博報堂DY(2433) | 2026イベント |

### 事前確認: 現行銘柄の1年パフォーマンス

**方法A: サーバーAPI**
```bash
# サーバー起動中の場合
curl "http://localhost:8000/perf/returns?tag=政策銘柄&windows=1y" | jq
```

**方法B: ymnk.jp**
- ブラウザで https://ymnk.jp を開く
- テーマ銘柄セクションを確認

**確認ポイント**
- 1年リターンがプラスの銘柄のみ採用（基本方針）
- マイナスの銘柄は除外または再検討

### 作業ステップ
1. **パフォーマンス確認**: 現行56銘柄の1年リターンを確認
2. 現行CSVをベースにv2作成
3. 新タグ列を追加
4. 既存銘柄のタグを再評価（1年リターンがマイナスなら除外検討）
5. 新規銘柄を追加
6. `meta.parquet` への反映スクリプト確認/更新

---

# Part 2: 母集団別統計分析（v2移行後）

## 目的

母集団ごとに異なる投資戦略を統計的に検証・最適化する。

## 母集団と投資戦略

| 母集団 | 戦略 | 保有期間 | 分析軸 |
|--------|------|----------|--------|
| Grok銘柄(急騰銘柄) | **ショート** | 当日〜数日 | 勝率・期待値 |
| テーマ銘柄(政策銘柄) | **ロング** | 1-2ヶ月 | ファンダメンタル・トレンド |
| TOPIX Core30 | ベンチマーク | - | 比較用 |

## 分析アプローチ

### Grok銘柄: ショート戦略の最適化
既存の `grok_trending_archive.parquet` (592レコード、70日分) を使用:

1. **基本統計**
   - phase1/2/3 勝率・平均リターン
   - 曜日別勝率
   - grok_rank別勝率

2. **条件別勝率**
   - selection_score帯別
   - 出来高倍率(vol_ratio)別

3. **有効条件の抽出**
   - 勝率 > 60% の条件を特定
   - 期待値がプラスになる閾値を探す

### テーマ銘柄: 維持/入れ替え判断

現行56銘柄は通年プラス実績あり。大発会+1/6時点でプラス継続中。

**判断基準**:
- 全銘柄がプラス継続 → 既存リスト維持
- マイナス銘柄あり → 入れ替え検討
- 新テーマ（フィジカルAI等）→ 追加

## 成果物

1. **Grok銘柄**: ショート選別基準（定量的閾値）
2. **テーマ銘柄**: ロング対象リスト（v2）+ 監視ルール

---

# Part 3: Grokショート必要資金算出 + ポートフォリオ生成

## 目的

Grokショートに必要な資金を算出し、余剰を政策銘柄ロングに割り当てる。

## 用語定義

- **除0銘柄**: いちにち信用で株数 > 0 の銘柄（取引可能）
- **制限値幅**: JPX規定の価格帯別値幅上限

## ロジック

```
最大必要資金 = (終値 + 制限値幅) × 100
日次必要資金 = Σ 除0銘柄の最大必要資金
平均必要資金 = 過去N日の日次必要資金の平均
余剰資金 = 総資金 - 平均必要資金 → 政策銘柄へ
```

## JPX制限値幅テーブル

参照: https://www.jpx.co.jp/equities/trading/domestic/06.html

| 基準値段 | 制限値幅 |
|----------|----------|
| 〜100円 | 30円 |
| 〜200円 | 50円 |
| 〜500円 | 80円 |
| 〜700円 | 100円 |
| 〜1,000円 | 150円 |
| 〜1,500円 | 300円 |
| 〜2,000円 | 400円 |
| 〜3,000円 | 500円 |
| 〜5,000円 | 700円 |
| 〜7,000円 | 1,000円 |
| 〜10,000円 | 1,500円 |
| 〜15,000円 | 3,000円 |
| 〜20,000円 | 4,000円 |
| 〜30,000円 | 5,000円 |
| 〜50,000円 | 7,000円 |
| 〜70,000円 | 10,000円 |
| 〜100,000円 | 15,000円 |
| 100,000円〜 | 30,000円 |

## 実装ステップ

### Step 1: 制限値幅関数の作成
- `scripts/lib/price_limit.py` に `calc_price_limit(price)` 関数作成

### Step 2: grok_trending_archive.parquet 更新
- `limit_price_upper` カラム追加
- `max_cost_100` カラム追加（100株最大必要資金）

### Step 3: pipeline 更新
- `grok_trending.parquet` 生成時に制限値幅を算出
- 対象: `scripts/pipeline/update_grok_*.py`

### Step 4: recommendations 更新
- 最大必要資金カラムを表示
- 対象: `server/routers/dev_recommendations.py`

### Step 5: analysis 追加
- 日次必要資金集計
- 過去N日平均算出
- ポートフォリオ配分提案

## 制約事項

- 信用残データはJ-Quants v2移行後に追加
- 現時点では価格・出来高・スコアベースの分析

## 対象ファイル

- 読み取り:
  - `data/parquet/backtest/grok_trending_archive.parquet`
  - `data/parquet/meta_jquants.parquet`
  - `data/parquet/meta.parquet`
  - `data/parquet/prices_max_1d.parquet`

- 出力(案):
  - `data/parquet/backtest/population_stats.parquet`
  - `output/population_analysis_report.md`
