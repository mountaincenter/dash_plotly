# スキャルピング戦略の哲学

## 前提認識

### 市場の不確実性

- 株式市場は長年研究されているが、不確実性が極めて高い
- 投資家心理による株価の騰落は予測困難
- **しかし、時系列データの機械的分析は人間より機械が得意**

### 本戦略の目的

手持ちのデータのみを用いて機械的に銘柄選別し、翌営業日にスキャルピングして利益を確保する

## 全体戦略体系（MECE）

```text
投資期間軸 × リスク許容度のマトリクス

【スイング（数日〜数週間）】
├─ Core30: 市場の中心銘柄（安定性重視）
└─ 高市銘柄: 政治情勢に基づく選定（時事性重視）

【デイスキャルピング（当日決済）】
├─ Entry: 60%の投資家が納得する王道分析
│   └─ 機械的判断 + 多数派の合意形成
├─ Active: 王道から外れない範囲でリスク許容
│   └─ 集中投資可能 + ボラティリティ重視
└─ Grok尖り銘柄: バズ・話題性による異常値検知
    └─ Grok API活用（人間では捉えにくいトレンド）
```

## スキャルピング銘柄選定の考え方

### 思想D: 品質保証付き動的選定

最終実装バージョン（2025-10-20現在）

### Entry（初心者向け：60%合意の王道）

**対象ユーザー:** 初心者〜中級者、安全性重視

**選定基準:**

```python
# 基本フィルタ
価格帯: 100-1500円  # 心理的安心感、流動性
流動性: Volume × Close >= 100,000,000円  # 約定リスク回避
ボラティリティ: 1.0% <= ATR <= 3.5%  # 予測可能な値動き
変動率: -3.0% <= change_pct <= +3.0%  # 安定的
テクニカル評価: 売り系以外（中立 + 買い + 強い買い）

# 品質保証付き動的選定（3-tier戦略）
target_n: 15銘柄（理想）
min_score_threshold: 75.0点
fallback_min_n: 5銘柄（最低保証）

# スコアリング項目（合計100点）
1. テクニカル評価（overall_rating）: 40点
   - 強い買い: 40点
   - 買い: 30点
   - 中立: 20点
   - 売り: 10点
   - 強い売り: 0点

2. 変動率（適度な動き）: 20点
   - 0.5-1.5%: 20点
   - 1.5-2.0%: 15点
   - 0.0-0.5%: 10点
   - その他: 0点

3. 出来高比率（流動性の高さ）: 20点
   - 150%以上: 20点
   - 120-150%: 15点
   - 100-120%: 10点
   - 100%未満: 5点

4. ATR（程よいボラティリティ）: 10点
   - 2.0-2.5%: 10点
   - 1.5-2.0%: 8点
   - 2.5-3.0%: 6点
   - その他: 4点

5. RSI（買われすぎ・売られすぎ回避）: 10点
   - 40-60: 10点
   - 30-40 or 60-70: 8点
   - その他: 5点
```

**選定ロジック:**

```python
1. 基本条件を満たす銘柄をフィルタリング
2. スコアリング（0-100点）を実施
3. スコア降順でソート

# 3-tier動的選定
if len(score >= 75.0) >= 15:
    → 高品質15銘柄を選定
elif len(score >= 75.0) >= 5:
    → 高品質銘柄のみ（5-14銘柄）を選定
else:
    → 基準緩和、上位5銘柄を選定（0件回避）
```

**思想:**

- **60%の投資家が納得する = 売りシグナルが出ていない**
- 「中立」は「買いでも売りでもない」= 許容可能
- 機械的判断による多数派の合意形成
- **品質と機会のバランス**: 理想は高品質15銘柄、最低でも5銘柄確保
- 王道を守る = 基本的なリスク管理を徹底

**期待候補数:** 5-15銘柄/日（市況により変動）

---

### Active（上級者向け：ボラティリティ重視）

**対象ユーザー:** 中級者〜上級者、ボラティリティ許容可能

**選定基準:**

```python
# 基本フィルタ
価格帯: 100-3000円  # より広範囲（流動性は担保）
流動性: Volume × Close >= 50,000,000円 OR vol_ratio >= 150%
ボラティリティ: ATR >= 2.5%  # 高ボラティリティ必須
変動率: |change_pct| >= 2.0%  # 当日既に動いている銘柄
テクニカル評価: 条件なし（参考情報のみ）

# 品質保証付き動的選定（3-tier戦略）
target_n: 15銘柄（理想）
min_score_threshold: 85.0点（Entryより厳しい）
fallback_min_n: 5銘柄（最低保証）

# スコアリング項目（合計100点）
1. ATR（高ボラティリティ重視）: 40点
   - 5.0%以上: 40点
   - 4.0-5.0%: 35点
   - 3.0-4.0%: 25点
   - 2.5-3.0%: 15点
   - 2.5%未満: 5点

2. 変動率（大きな動き）: 30点
   - 5.0%以上: 30点
   - 4.0-5.0%: 25点
   - 3.0-4.0%: 20点
   - 2.0-3.0%: 15点
   - 2.0%未満: 5点

3. 出来高比率（急騰・急落の兆候）: 20点
   - 200%以上: 20点
   - 150-200%: 15点
   - 100-150%: 10点
   - 100%未満: 5点

4. RSI（極端な状態を許容）: 10点
   - 20-30 or 70-80: 10点（反転期待）
   - 30-40 or 60-70: 8点
   - 40-60: 6点（中立は低評価）
   - その他: 4点
```

**選定ロジック:**

```python
1. 基本条件を満たす銘柄をフィルタリング
2. スコアリング（0-100点）を実施
3. スコア降順でソート

# 3-tier動的選定
if len(score >= 85.0) >= 15:
    → 高品質15銘柄を選定
elif len(score >= 85.0) >= 5:
    → 高品質銘柄のみ（5-14銘柄）を選定
else:
    → 基準緩和、上位5銘柄を選定（0件回避）
```

**思想:**

- **スキャルピングの利益源泉 = ボラティリティ**
- overall_rating を条件にしない = 機械的・データドリブン
- 「王道を外れない」= 価格・流動性・ATRで健全性を担保
- テクニカル評価は参考情報として計算するが、選別条件にしない
- **高品質基準（85点）で厳選、最低5銘柄は確保**

**期待候補数:** 5-15銘柄/日（市況により変動）

---

### Grok尖り銘柄（実装済み：手動運用）

**対象ユーザー:** 上級者、話題性・バズに賭ける

**選定基準:**

```python
# 手動運用（Grokに依頼して定期的に更新）
銘柄数: 10-15銘柄
更新頻度: 週次〜月次（市況に応じて）

# Grokが評価する要素
1. SNS（X/Twitter）での言及急増
2. ニュース・メディア露出の急増
3. 特定テーマ（AI、半導体、防衛、バイオ等）での話題性
4. 企業発表（決算サプライズ、新製品、M&A等）
5. 出来高急増など市場での異常値
6. 個人投資家コミュニティでの注目度

# 除外条件
市場: 東証プライム・スタンダード限定
価格: 100円以上
流動性: 極端に低い銘柄は除外
```

**出力フォーマット:**

```python
# grok_trending.parquet
columns: [ticker_symbol, company_name, reason, category, selected_date]

ticker_symbol: 4桁の銘柄コード（文字列）
company_name: 会社名
reason: 選定理由（具体的な数値・根拠付き、100文字程度）
category: 話題のカテゴリ（例: AI, 防衛, 半導体, バイオ等）
selected_date: 選定日（YYYY-MM-DD形式）
```

**思想:**

- 人間では捉えにくいトレンド・バズをGrokで検知
- Entry/Activeとは独立した選定軸（話題性・異常値重視）
- Core30・高市銘柄との一部重複は許容（異なる視点での選定）
- 高リスク・高リターン（話題性は短期的に変動）

**運用方法:**

1. Grokに専用プロンプトを投げる（週次〜月次）
2. `scripts/pipeline/generate_grok_trending.py` を更新
3. スクリプト実行で `grok_trending.parquet` を生成
4. 必要に応じてS3にアップロード

**実装状況:** Phase 5（2025-10-20）

**期待候補数:** 10-15銘柄/更新

---

## 設計原則

### 1. 機械的判断の徹底

- **人間のバイアスを排除**
- データのみに基づく選別
- overall_rating は「計算はするが、過度に依存しない」

### 2. 段階的リスク分離

- Entry: 安全性重視（多数派合意）
- Active: ボラティリティ重視（機会創出）
- Grok: 異常値検知（バズ・話題性）

### 3. 王道からの逸脱防止

- 価格帯による健全性担保（100-3000円）
- 流動性による約定リスク回避
- ATRによるボラティリティ管理

### 4. 品質と機会のバランス

- **部分最適（固定top_n）**: 低品質でも15銘柄埋める → 微妙な銘柄が混入
- **全体最適（厳格な基準）**: 高品質のみ選定 → 0銘柄のリスク
- **ベターな解（3-tier戦略）**:
  - Ideal: 高品質15銘柄
  - Acceptable: 高品質5-14銘柄
  - Fallback: 上位5銘柄（0件回避）

### 5. 自己責任の大前提

- 市場は不確実
- 機械的選別 ≠ 利益保証
- 最終判断は投資家自身

---

## 実装の変遷

### Phase 1: overall_rating依存（2025-10-19以前）

**問題:**

- Entry候補: 0件
- Active候補: 0件
- 原因: overall_rating条件が厳しすぎる（「買い」「強い買い」のみ）

### Phase 2: 条件緩和（2025-10-19）

**Entry条件変更:**

```python
# Before
overall_rating.isin(['買い', '強い買い'])

# After
~overall_rating.isin(['売り', '強い売り'])
```

**Active条件変更:**

```python
# Before
overall_rating.isin(['買い', '強い買い'])

# After
# overall_rating条件を完全削除
```

### Phase 3: スコアリング導入（2025-10-20）

**Entry:**

- 5項目スコアリング（overall_rating, change_pct, vol_ratio, atr, rsi）
- 合計100点満点で評価
- 75点以上を高品質と定義

**Active:**

- 4項目スコアリング（ATR重視、overall_rating除外）
- 合計100点満点で評価
- 85点以上を高品質と定義

### Phase 4: 品質保証付き動的選定（2025-10-20 最終版）

**3-tier戦略:**

1. **Ideal**: 高品質銘柄が15銘柄以上 → 15銘柄選定
2. **Acceptable**: 高品質銘柄が5-14銘柄 → 全て選定
3. **Fallback**: 高品質銘柄が5銘柄未満 → 上位5銘柄選定（基準緩和）

**メリット:**

- 高品質を優先しつつ、0銘柄を回避
- 市況に応じて柔軟に対応
- 部分最適と全体最適のバランス

---

## 期待される効果

### 1. 機会創出

毎営業日に取引候補が確保される（最低5銘柄保証）

### 2. リスク分離

Entry/Active で明確に投資家層を分ける

### 3. 機械的判断

バイアスなしにデータで選別（スコアリングによる定量化）

### 4. 王道維持

価格・流動性・ATRで健全性担保

### 5. 品質と機会のバランス

固定枠でも厳格すぎでもない「ベターな解」を実現

---

## データパイプライン統合

### 営業日判定

- **実行ウィンドウ**: 営業日の16:00～翌2:00（26:00）
- **J-Quants Trading Calendar API**: HolidayDivision == "1" のみ（全日立会）
- **週次meta更新**: 毎週金曜日（または金曜が休日なら最終営業日）

### 障害時対応

**J-Quants障害時:**

- meta_jquants.parquet: 空ファイル作成（正しいスキーマ）
- scalping_entry.parquet: 空ファイル作成（14カラム）
- scalping_active.parquet: 空ファイル作成（14カラム）
- 静的銘柄（meta.parquet）のみで処理継続

**yfinance障害時:**

- 空のpriceファイル作成
- 処理を諦めて継続（return 0）

**S3障害時:**

- エラーを返して停止（return 1）
- 早期検知のため

---

## 次のステップ

### 1. データ検証（STEP 5.5の活用）

- スコア分布の確認
- 各条件の通過率分析
- 候補数の妥当性検証
- 日次モニタリング

### 2. 継続的改善

- 実取引結果のフィードバック
- スコア配点の微調整（データドリブン）
- target_n, min_score_threshold, fallback_min_n のチューニング

### 3. モニタリング

- 日次の候補数推移（5-15銘柄の範囲内か）
- Entry/Activeのパフォーマンス比較
- 市場環境との相関分析
- 3-tier戦略の各層の発動頻度

### 4. 将来展望

- Grok尖り銘柄の実装（Grok API統合）
- 機械学習モデルの導入検討
- バックテスト環境の構築

---

**最終更新:** 2025-10-20
**現在のバージョン:** Phase 4（品質保証付き動的選定）
**関連ファイル:**

- `scripts/lib/screener.py` - スコアリング・選定ロジック
- `scripts/pipeline/generate_scalping.py` - パイプライン統合
- `scripts/check_trading_day.py` - 営業日判定

**関連コミット:**

- `e3b193b` 未使用ディレクトリ削除（analyze, jquants）
- `90c9d6c` 手動強制実行オプション追加
- `16d63d2` 未使用GitHub Actions workflows削除
