name: J-Quants Scalping Selection

on:
  schedule:
    - cron: '0 7 * * *'  # 16:00 JST (å¸‚å ´çµ‚äº†å¾Œ)
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read
  actions: write  # ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ãŸã‚ã«å¿…è¦

jobs:
  scalping:
    runs-on: ubuntu-latest
    environment: AWS_OIDC

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install jquants-api-client

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'ap-northeast-1' }}

      - name: Run J-Quants scalping selection
        id: jquants
        continue-on-error: true
        env:
          JQUANTS_REFRESH_TOKEN: ${{ secrets.JQUANTS_REFRESH_TOKEN }}
        run: |
          echo "ğŸ“Š Starting J-Quants scalping stock selection..."
          python jquants/generate_scalping_final.py

      - name: Create empty parquet files if J-Quants failed
        if: steps.jquants.outcome == 'failure'
        run: |
          echo "âš ï¸ J-Quants failed, creating empty scalping parquet files..."
          python scripts/create_empty_scalping.py

      - name: Upload scalping results to S3
        if: always()
        run: |
          BUCKET="${{ vars.DATA_BUCKET || vars.S3_BUCKET }}"
          PREFIX="${{ vars.PARQUET_PREFIX || 'parquet/' }}"

          # scalping_entry.parquet
          if [ -f "scalping_entry.parquet" ]; then
            aws s3 cp scalping_entry.parquet "s3://${BUCKET}/${PREFIX}scalping_entry.parquet"
            echo "âœ… Uploaded scalping_entry.parquet"
          else
            echo "âŒ scalping_entry.parquet not found (should not happen)"
            exit 1
          fi

          # scalping_active.parquet
          if [ -f "scalping_active.parquet" ]; then
            aws s3 cp scalping_active.parquet "s3://${BUCKET}/${PREFIX}scalping_active.parquet"
            echo "âœ… Uploaded scalping_active.parquet"
          else
            echo "âŒ scalping_active.parquet not found (should not happen)"
            exit 1
          fi

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jquants-scalping-results
          path: |
            scalping_entry.parquet
            scalping_active.parquet
          if-no-files-found: warn

      - name: Trigger YFinance workflow
        if: always()  # J-QuantsæˆåŠŸ/å¤±æ•—ã«é–¢ã‚ã‚‰ãšå¸¸ã«YFinanceã‚’å®Ÿè¡Œ
        run: |
          echo "ğŸš€ Triggering YFinance data update workflow..."
          gh workflow run yfinance-data-update.yml --ref main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Slack notification on success
        if: steps.jquants.outcome == 'success'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_INCOMING_WEBHOOK_URL }}
        run: |
          RESULT=$(python scripts/get_scalping_info.py)
          ENTRY_COUNT=$(echo "$RESULT" | jq -r '.entry_count')
          ACTIVE_COUNT=$(echo "$RESULT" | jq -r '.active_count')
          ENTRY_TICKERS=$(echo "$RESULT" | jq -r '.entry_tickers')
          ACTIVE_TICKERS=$(echo "$RESULT" | jq -r '.active_tickers')

          MESSAGE='{
            "text": "âœ… J-Quants Scalping Selection Succeeded",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "âœ… *J-Quants Scalping Selection Succeeded*\nWorkflow `${{ github.workflow }}` in `${{ github.repository }}` completed successfully.\n\nğŸš€ YFinance workflow triggered automatically."
                }
              },
              {
                "type": "section",
                "fields": [
                  {"type": "mrkdwn", "text": "*Entry Stocks:*\n`'"${ENTRY_COUNT}"'`ä»¶"},
                  {"type": "mrkdwn", "text": "*Active Stocks:*\n`'"${ACTIVE_COUNT}"'`ä»¶"},
                  {"type": "mrkdwn", "text": "*Branch:*\n`${{ github.ref_name }}`"},
                  {"type": "mrkdwn", "text": "*Event:*\n`${{ github.event_name }}`"}
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ğŸ“‹ EntryéŠ˜æŸ„:*\n`'"${ENTRY_TICKERS}"'`\n\n*ğŸ“‹ ActiveéŠ˜æŸ„:*\n`'"${ACTIVE_TICKERS}"'`"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "View Workflow Run"},
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }'
          curl -X POST -H 'Content-type: application/json' --data "$MESSAGE" $SLACK_WEBHOOK_URL

      - name: Send Slack notification on failure
        if: steps.jquants.outcome == 'failure'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_INCOMING_WEBHOOK_URL }}
        run: |
          MESSAGE='{
            "text": "âš ï¸ J-Quants Scalping Selection Failed (Fallback Active)",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "âš ï¸ *J-Quants Scalping Selection Failed*\nWorkflow `${{ github.workflow }}` in `${{ github.repository }}` encountered an error.\n\nâœ… ç©ºã®parquetãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ\nğŸš€ YFinance workflow triggered (Core30 + é«˜å¸‚æ ªã¯æ›´æ–°ã•ã‚Œã¾ã™)"
                }
              },
              {
                "type": "section",
                "fields": [
                  {"type": "mrkdwn", "text": "*Entry Stocks:*\n`0`ä»¶ (ç©ºãƒ•ã‚¡ã‚¤ãƒ«)"},
                  {"type": "mrkdwn", "text": "*Active Stocks:*\n`0`ä»¶ (ç©ºãƒ•ã‚¡ã‚¤ãƒ«)"},
                  {"type": "mrkdwn", "text": "*Branch:*\n`${{ github.ref_name }}`"},
                  {"type": "mrkdwn", "text": "*Event:*\n`${{ github.event_name }}`"}
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ…‹:*\nâ€¢ `scalping_entry.parquet`: ç©ºãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆæ¸ˆã¿\nâ€¢ `scalping_active.parquet`: ç©ºãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆæ¸ˆã¿\n\n*ç†ç”±:* J-Quants API ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œå¤±æ•—"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "View Workflow Run"},
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }'
          curl -X POST -H 'Content-type: application/json' --data "$MESSAGE" $SLACK_WEBHOOK_URL
