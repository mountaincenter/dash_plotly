name: Test Slack Notification

on:
  workflow_dispatch:
    inputs:
      notification_type:
        description: "é€šçŸ¥ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ"
        type: choice
        options:
          - grok_formatted
          - grok_current
          - pipeline_success
        default: grok_formatted

permissions:
  contents: read

jobs:
  test-slack:
    name: Send Test Slack Notification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send GROK formatted notification (improved)
        if: github.event.inputs.notification_type == 'grok_formatted'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_INCOMING_WEBHOOK_URL }}
        run: |
          MESSAGE='{
            "text": "ğŸ“Š GROKéŠ˜æŸ„æ›´æ–°ãƒ†ã‚¹ãƒˆ (æ”¹å–„ç‰ˆ)",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ğŸ“ˆ GROKéŠ˜æŸ„æ›´æ–° (ãƒ†ã‚¹ãƒˆ - æ”¹å–„ç‰ˆ)"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*16:00æ›´æ–°:*\n12éŠ˜æŸ„"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*åˆè¨ˆ:*\n12éŠ˜æŸ„"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*1. 4592.T ã‚µãƒ³ãƒã‚¤ã‚ª* `[16:00]`\n`ãƒã‚¤ã‚ªææ–™ + æ ªã‚¯ãƒ©ãƒã‚º`\n> 2025å¹´10æœˆ24æ—¥å¼•ã‘å¾Œã«å†ç”ŸåŒ»ç™‚é–¢é€£ã®æ²»é¨“é€²å±•IRã‚’ç™ºè¡¨ã€‚Xã§ã€Œ2025å¹´10æœˆ27æ—¥å¯„ä»˜è²·ã„ã€ã®æŠ•ç¨¿ãŒ150ä»¶ä»¥ä¸Šç¢ºèª..."
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*2. 7779.T CYBERDYNE* `[16:00]`\n`IRå¥½ææ–™ + æ ªã‚¯ãƒ©ãƒã‚º`\n> 2025å¹´10æœˆ24æ—¥å¼•ã‘å¾Œã«ãƒ­ãƒœãƒƒãƒˆãƒªãƒãƒ“ãƒªæ©Ÿå™¨ã®æ–°è£½å“ç™ºè¡¨IRã€‚Xã§ã€Œ2025å¹´10æœˆ27æ—¥ä»•è¾¼ã‚€ã€ã¨ã®æŠ•ç¨¿ãŒæ€¥å¢—ï¼ˆç´„120ä»¶ï¼‰..."
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*3. 3914.T JIG-SAW* `[16:00]`\n`IRå¥½ææ–™ + æ ªã‚¯ãƒ©ãƒã‚º`\n> 2025å¹´10æœˆ24æ—¥å¤œã«IoTé–¢é€£ã®æ¥­å‹™ææºIRã‚’ç™ºè¡¨ã€‚Xã§ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°#æ³¨ç›®éŠ˜æŸ„ä»˜ãã®æŠ•ç¨¿ãŒ80ä»¶ä»¥ä¸Š..."
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*4. 7071.T ã‚¢ãƒ³ãƒ“ã‚¹HD* `[16:00]`\n`æ±ºç®—å¥½ææ–™ + æ ªã‚¯ãƒ©ãƒã‚º`\n> 2025å¹´10æœˆ24æ—¥å¼•ã‘å¾Œã«å¥½æ±ºç®—ç™ºè¡¨ã€‚Xã§ã€Œ2025å¹´10æœˆ27æ—¥ã‚¹ãƒˆãƒƒãƒ—é«˜ç‹™ã„ã€ã®å£°ãŒ100ä»¶ä»¥ä¸Š..."
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*5. 6195.T ãƒ›ãƒ¼ãƒ—* `[16:00]`\n`IRå¥½ææ–™ + æ ªã‚¯ãƒ©ãƒã‚º`\n> 2025å¹´10æœˆ24æ—¥å¤œã«è‡ªæ²»ä½“å‘ã‘DXã‚µãƒ¼ãƒ“ã‚¹ã®å—æ³¨IRç™ºè¡¨ã€‚Xã§ã€Œ2025å¹´10æœˆ27æ—¥è²·ã„ã€ã®æŠ•ç¨¿ãŒ90ä»¶ä»¥ä¸Š..."
                }
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "ğŸ“‹ _ä»–7éŠ˜æŸ„: 6. 4393.T ãƒãƒ³ã‚¯ãƒ»ã‚ªãƒ–ãƒ»ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³, 7. 3674.T ã‚ªãƒ¼ã‚¯ãƒ•ã‚¡ãƒ³, 8. 7033.T ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚º, 9. 4055.T ãƒ†ã‚£ã‚¢ãƒ³ãƒ‰ã‚¨ã‚¹, 10. 6082.T ãƒ©ã‚¤ãƒ‰ã‚ªãƒ³ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ã‚¹HD, 11. 4425.T Kudan, 12. 7359.T æ±äº¬é€šä¿¡ã‚°ãƒ«ãƒ¼ãƒ—_"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "ğŸ’¡ *æ”¹å–„ç‚¹:* ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ†å‰²ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ã§ã‚¿ã‚°è¡¨ç¤ºã€å¼•ç”¨ãƒ–ãƒ­ãƒƒã‚¯ã§ç†ç”±ã‚’æ•´ç†ã€æ®‹ã‚Šã®éŠ˜æŸ„ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«è¡¨ç¤º"
                  }
                ]
              }
            ]
          }'
          curl -X POST -H 'Content-type: application/json' --data "$MESSAGE" "$SLACK_WEBHOOK_URL"

      - name: Send GROK current notification (ç¾åœ¨ã®å½¢å¼)
        if: github.event.inputs.notification_type == 'grok_current'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_INCOMING_WEBHOOK_URL }}
        run: |
          # ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆè¦‹ã¥ã‚‰ã„ç‰ˆï¼‰
          MESSAGE='{
            "text": "ğŸ“Š GROKéŠ˜æŸ„æ›´æ–°ãƒ†ã‚¹ãƒˆ (ç¾åœ¨ã®å½¢å¼)",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ":ä¸Šæ˜‡æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•: *GROKéŠ˜æŸ„æ›´æ–°*\n\n  16:00æ›´æ–°: 12éŠ˜æŸ„\n  åˆè¨ˆ: 12éŠ˜æŸ„\n\n1. 4592.T ã‚µãƒ³ãƒã‚¤ã‚ª [16:00]\n   _ãƒã‚¤ã‚ªææ–™+æ ªã‚¯ãƒ©ãƒã‚º_\n   2025å¹´10æœˆ24æ—¥å¼•ã‘å¾Œã«å†ç”ŸåŒ»ç™‚é–¢é€£ã®æ²»é¨“é€²å±•IRã‚’ç™ºè¡¨ã€‚Xã§ã€Œ2025å¹´10æœˆ27æ—¥å¯„ä»˜è²·ã„ã€ã®æŠ•ç¨¿ãŒ150ä»¶ä»¥ä¸Šç¢ºèªã€æœ‰åæŠ•è³‡å®¶ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼2ä¸‡äººï¼‰ã‚‚è¨€åŠã€‚2025å¹´10æœˆ24æ—¥å‡º...\n\n2. 7779.T CYBERDYNE [16:00]\n   _IRå¥½ææ–™+æ ªã‚¯ãƒ©ãƒã‚º_\n   2025å¹´10æœˆ24æ—¥å¼•ã‘å¾Œã«ãƒ­ãƒœãƒƒãƒˆãƒªãƒãƒ“ãƒªæ©Ÿå™¨ã®æ–°è£½å“ç™ºè¡¨IRã€‚Xã§ã€Œ2025å¹´10æœˆ27æ—¥ä»•è¾¼ã‚€ã€ã¨ã®æŠ•ç¨¿ãŒæ€¥å¢—ï¼ˆç´„120ä»¶ï¼‰ã€‚2025å¹´10æœˆ24æ—¥å‡ºæ¥é«˜ã¯å¹³å‡ã®3.2å€ã€ATR 4.8%ã€æ™‚...\n\n3. 3914.T JIG-SAW [16:00]\n   _IRå¥½ææ–™+æ ªã‚¯ãƒ©ãƒã‚º_\n   2025å¹´10æœˆ24æ—¥å¤œã«IoTé–¢é€£ã®æ¥­å‹™ææºIRã‚’ç™ºè¡¨ã€‚Xã§ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°#æ³¨ç›®éŠ˜æŸ„ä»˜ãã®æŠ•ç¨¿ãŒ80ä»¶ä»¥ä¸Šã€‚2025å¹´10æœˆ24æ—¥å‡ºæ¥é«˜ã¯å¹³å‡ã®2.5å€ã€ATR 5.2%ã€æ™‚ä¾¡ç·é¡180å„„å††ã§å€‹äººæŠ•è³‡..."
                }
              }
            ]
          }'
          curl -X POST -H 'Content-type: application/json' --data "$MESSAGE" "$SLACK_WEBHOOK_URL"

      - name: Send pipeline success notification
        if: github.event.inputs.notification_type == 'pipeline_success'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_INCOMING_WEBHOOK_URL }}
        run: |
          MESSAGE='{
            "text": "âœ… Data Pipeline Succeeded (Test)",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "âœ… *Data Pipeline Succeeded (Test)*\nWorkflow test notification."
                }
              },
              {
                "type": "section",
                "fields": [
                  {"type": "mrkdwn", "text": "*Branch:*\n`main`"},
                  {"type": "mrkdwn", "text": "*Trigger:*\n`Manual Test`"},
                  {"type": "mrkdwn", "text": "*J-Quants:*\nâœ… æ­£å¸¸"},
                  {"type": "mrkdwn", "text": "*Latest Price Date:*\n`2025-10-25`"}
                ]
              },
              {
                "type": "section",
                "fields": [
                  {"type": "mrkdwn", "text": "*meta_jquants:*\n`3790`éŠ˜æŸ„"},
                  {"type": "mrkdwn", "text": "*all_stocks:*\n`3800`éŠ˜æŸ„"},
                  {"type": "mrkdwn", "text": "*grok_trending:*\n`12`éŠ˜æŸ„ (NEW)"},
                  {"type": "mrkdwn", "text": "*scalping (skipped):*\n`0`/`0`éŠ˜æŸ„"}
                ]
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "View Workflow Run"},
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }'
          curl -X POST -H 'Content-type: application/json' --data "$MESSAGE" "$SLACK_WEBHOOK_URL"

      - name: Test completed
        run: |
          echo "âœ… Slack notification test completed"
          echo "Selected type: ${{ github.event.inputs.notification_type }}"
